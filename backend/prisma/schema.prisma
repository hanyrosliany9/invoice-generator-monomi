// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Management
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  role      UserRole @default(STAFF)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  quotations            Quotation[]            @relation("QuotationCreator")
  quotationsApproved    Quotation[]            @relation("QuotationApprover")
  quotationsRejected    Quotation[]            @relation("QuotationRejector")
  invoices              Invoice[]              @relation("InvoiceCreator")
  invoicesPaidMarked    Invoice[]              @relation("InvoicePaidMarker")
  auditLogs             AuditLog[]
  preferences           UserPreferences?
  businessJourneyEvents BusinessJourneyEvent[] @relation("BusinessJourneyEventCreator")

  // Asset Management Relations
  assets            Asset[]            @relation("CreatedAssets")
  assetReservations AssetReservation[] @relation("AssetReservationUser")

  // Expense Management Relations
  expenses         Expense[]                @relation("ExpenseSubmitter")
  approvedExpenses Expense[]                @relation("ExpenseApprover")
  expenseApprovals ExpenseApprovalHistory[] @relation("ExpenseApprovalUser")
  expenseComments  ExpenseComment[]         @relation("ExpenseCommentUser")
  expenseBudgets   ExpenseBudget[]          @relation("UserExpenseBudget")

  // Team & Resources Relations
  projectAssignments ProjectTeamMember[] @relation("UserProjectAssignments")
  laborEntries       LaborEntry[]        @relation("UserLaborEntries")

  // Content Management Relations
  contentCalendarItems ContentCalendarItem[]

  // Media Collaboration Relations
  mediaProjects          MediaProject[]      @relation("MediaProjectCreator")
  mediaFolders           MediaFolder[]       @relation("MediaFolderCreator")
  mediaAssetsUploaded    MediaAsset[]        @relation("MediaAssetUploader")
  mediaVersionsUploaded  MediaVersion[]      @relation("MediaVersionUploader")
  mediaFramesCreated     MediaFrame[]        @relation("MediaFrameCreator")
  frameCommentsAuthored  FrameComment[]      @relation("FrameCommentAuthor")
  frameCommentsResolved  FrameComment[]      @relation("FrameCommentResolver")
  frameDrawingsCreated   FrameDrawing[]      @relation("FrameDrawingCreator")
  mediaCollaborations    MediaCollaborator[] @relation("MediaCollaboratorUser")
  mediaCollaboratorInvitations MediaCollaborator[] @relation("MediaCollaboratorInviter")
  collectionsCreated     Collection[]        @relation("CollectionCreator")
  assetMetadataAssignee  AssetMetadata[]     @relation("AssetAssignee")

  // Deck Presentation Relations
  decksCreated       Deck[]              @relation("DeckCreator")
  deckCollaborations DeckCollaborator[]  @relation("DeckCollaboratorUser")
  deckInvitesSent    DeckCollaborator[]  @relation("DeckInviter")
  deckSlideComments  DeckSlideComment[]  @relation("DeckSlideCommentAuthor")

  // Shot List Relations
  shotLists          ShotList[]          @relation("ShotListCreator")

  // Shooting Schedule & Call Sheet Relations
  shootingSchedules  ShootingSchedule[]  @relation("ScheduleCreator")
  callSheets         CallSheet[]         @relation("CallSheetCreator")

  // Authentication Relations
  refreshTokens RefreshToken[]

  @@map("users")
}

// Refresh Token Management (OAuth2 Pattern)
model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Token metadata
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  lastUsedAt DateTime @default(now())

  // Security fields
  isRevoked      Boolean  @default(false)
  revokedAt      DateTime?
  revokedReason  String?  // "logout", "security", "expired", "replaced"

  // Device tracking (for multi-device support)
  userAgent String?
  ipAddress String?
  deviceId  String? // Client-generated UUID for device identification

  // Audit trail
  replacedBy String? // ID of new refresh token (for rotation)

  @@index([userId, isRevoked, expiresAt])
  @@index([token, isRevoked])
  @@map("refresh_tokens")
}

// Client Management
model Client {
  id      String  @id @default(cuid())
  name    String
  email   String?
  phone   String?
  address String?
  company String?

  // Contact details
  contactPerson String?

  // Business details
  paymentTerms String? // Default payment terms
  status       String  @default("active") // Client status: active, inactive
  taxNumber    String? // NPWP / Tax Number
  bankAccount  String? // Bank account information
  notes        String? @db.Text // Additional notes

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  quotations            Quotation[]
  invoices              Invoice[]
  projects              Project[]
  businessJourneyEvents BusinessJourneyEvent[]
  expenses              Expense[] // Client-related expenses
  contentCalendarItems  ContentCalendarItem[]
  mediaProjects         MediaProject[] // Media collaboration projects
  decks                 Deck[]

  @@index([name])
  @@index([email])
  @@index([createdAt])
  @@index([phone])
  // Composite indexes for client search and filtering
  @@index([status, createdAt])
  @@index([name, status])
  @@map("clients")
}

// Project Management
model Project {
  id            String            @id @default(cuid())
  number        String            @unique // Project number for reference
  description   String // Project description
  scopeOfWork   String?           @db.Text // Narrative scope of work description
  output        String // Expected deliverables/output
  // Project type reference
  projectTypeId String
  projectType   ProjectTypeConfig @relation(fields: [projectTypeId], references: [id])

  // Client reference
  clientId String
  client   Client @relation(fields: [clientId], references: [id])

  // Project timeline
  startDate DateTime?
  endDate   DateTime?

  // Budget information
  estimatedBudget Decimal? @db.Decimal(12, 2)
  basePrice       Decimal? @db.Decimal(12, 2) // Base project price for cascade
  priceBreakdown  Json? // Detailed price items (optional)

  // ===== PROJECT PROJECTION (Planning Phase) =====

  // Estimated expense breakdown (before project starts)
  estimatedExpenses Json? // JSON storage for estimated costs by category

  // Projected profit metrics (calculated during planning)
  projectedGrossMargin Decimal? @db.Decimal(5, 2) // Estimated gross margin %
  projectedNetMargin   Decimal? @db.Decimal(5, 2) // Estimated net margin %
  projectedProfit      Decimal? @db.Decimal(15, 2) // Estimated profit amount

  // ===== PROFIT MARGIN TRACKING =====

  // Cost Tracking (auto-calculated from expenses & allocations)
  totalDirectCosts    Decimal? @default(0) @db.Decimal(15, 2) // Direct materials, labor, expenses
  totalIndirectCosts  Decimal? @default(0) @db.Decimal(15, 2) // Allocated overhead
  totalAllocatedCosts Decimal? @default(0) @db.Decimal(15, 2) // Total costs (direct + indirect)

  // Revenue Tracking (auto-calculated from invoices)
  totalInvoicedAmount Decimal? @default(0) @db.Decimal(15, 2) // Sum of all invoices
  totalPaidAmount     Decimal? @default(0) @db.Decimal(15, 2) // Sum of paid invoices only

  // Profit Calculations (auto-calculated)
  grossProfit        Decimal? @db.Decimal(15, 2) // Revenue - Direct Costs
  netProfit          Decimal? @db.Decimal(15, 2) // Revenue - Total Costs
  grossMarginPercent Decimal? @db.Decimal(5, 2) // Gross profit margin %
  netMarginPercent   Decimal? @db.Decimal(5, 2) // Net profit margin %

  // Budget Variance Analysis
  budgetVariance        Decimal? @db.Decimal(15, 2) // Actual - Estimated
  budgetVariancePercent Decimal? @db.Decimal(5, 2) // Variance %

  // Calculation Metadata
  profitCalculatedAt DateTime? // Last calculation timestamp
  profitCalculatedBy String? // User who triggered calculation

  status    ProjectStatus @default(PLANNING)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  // Relations
  quotations            Quotation[]
  invoices              Invoice[]
  businessJourneyEvents BusinessJourneyEvent[]
  documents             Document[]
  expenses              Expense[] // Project-related expenses
  expenseBudgets        ExpenseBudget[] // Project budgets

  // Asset Management Relations
  equipmentUsage    ProjectEquipmentUsage[]
  assetReservations AssetReservation[]

  // PSAK 72: Revenue Recognition
  milestones ProjectMilestone[]

  // PSAK 57: Work in Progress & Cost Allocation
  workInProgress  WorkInProgress[]
  costAllocations ProjectCostAllocation[]

  // Team & Resources Relations
  teamMembers  ProjectTeamMember[] @relation("ProjectTeam")
  laborEntries LaborEntry[]        @relation("ProjectLabor")

  // ===== PURCHASE-TO-PAY INTEGRATION =====
  purchaseOrders PurchaseOrder[] // Purchase Orders (for budget tracking)

  // Social Media & Content Relations
  socialMediaReports   SocialMediaReport[]
  contentCalendarItems ContentCalendarItem[]
  mediaProjects        MediaProject[] // Media collaboration projects
  decks                Deck[]

  // Shot List Relations
  shotLists            ShotList[]

  // Shooting Schedule Relations
  shootingSchedules    ShootingSchedule[]

  @@index([number])
  @@index([status])
  @@index([projectTypeId])
  @@index([clientId])
  @@index([createdAt])
  // Composite indexes for performance optimization
  @@index([clientId, status])
  @@index([projectTypeId, status])
  @@index([status, createdAt])
  // Profit margin indexes for reporting and filtering
  @@index([grossMarginPercent])
  @@index([netMarginPercent])
  @@index([totalAllocatedCosts])
  @@index([profitCalculatedAt])
  // Projection indexes for planning queries
  @@index([projectedNetMargin])
  @@map("projects")
}

// Quotation Management
model Quotation {
  id              String   @id @default(cuid())
  quotationNumber String   @unique
  date            DateTime @default(now())
  validUntil      DateTime

  // Client information
  clientId String
  client   Client @relation(fields: [clientId], references: [id])

  // Project information
  projectId String
  project   Project @relation(fields: [projectId], references: [id])

  // Financial details
  amountPerProject Decimal @db.Decimal(12, 2)
  totalAmount      Decimal @db.Decimal(12, 2)

  // Scope of Work and pricing
  scopeOfWork    String? @db.Text // Narrative scope of work (inherited or custom)
  priceBreakdown Json? // Detailed price items inherited from project

  // Terms and conditions
  terms String?

  // Payment Structure (Phase 1 Enhancement: Milestone Support)
  paymentType      PaymentType @default(FULL_PAYMENT) // FULL_PAYMENT or MILESTONE_BASED
  paymentTermsText String?     @db.Text // Legacy text field (keep for compatibility)

  // Status management
  status QuotationStatus @default(DRAFT)

  // User tracking
  createdBy String
  user      User   @relation("QuotationCreator", fields: [createdBy], references: [id], onDelete: Restrict)

  // Approval audit fields (RBAC)
  approvedBy String?
  approver   User?     @relation("QuotationApprover", fields: [approvedBy], references: [id], onDelete: SetNull)
  approvedAt DateTime?
  rejectedBy String?
  rejector   User?     @relation("QuotationRejector", fields: [rejectedBy], references: [id], onDelete: SetNull)
  rejectedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  invoices              Invoice[]
  paymentMilestones     PaymentMilestone[] // Phase 1 Enhancement: Payment milestones for quotations
  businessJourneyEvents BusinessJourneyEvent[]
  documents             Document[]

  @@index([quotationNumber])
  @@index([status])
  @@index([clientId])
  @@index([projectId])
  @@index([createdAt])
  @@index([validUntil])
  // Composite indexes for performance optimization
  @@index([clientId, status])
  @@index([status, validUntil])
  @@index([projectId, status])
  @@index([createdAt, status])
  @@map("quotations")
}

// Invoice Management
model Invoice {
  id            String   @id @default(cuid())
  invoiceNumber String   @unique
  creationDate  DateTime @default(now())
  dueDate       DateTime

  // Reference to quotation (optional - invoices can be standalone)
  quotationId String?
  quotation   Quotation? @relation(fields: [quotationId], references: [id])

  // Client information (denormalized for invoice independence)
  clientId String
  client   Client @relation(fields: [clientId], references: [id])

  // Project information (denormalized)
  projectId String
  project   Project @relation(fields: [projectId], references: [id])

  // Financial details
  amountPerProject Decimal @db.Decimal(12, 2)
  totalAmount      Decimal @db.Decimal(12, 2)

  // Tax details (Indonesian PPN compliance)
  subtotalAmount Decimal? @db.Decimal(15, 2) // Amount before tax
  taxRate        Decimal? @db.Decimal(5, 2) // Tax percentage (e.g., 11.00 for PPN 11%)
  taxAmount      Decimal? @db.Decimal(15, 2) // Calculated tax amount
  includeTax     Boolean  @default(false) // Whether totalAmount includes tax

  // Scope of Work and pricing
  scopeOfWork    String? @db.Text // Narrative scope of work (inherited from quotation/project)
  priceBreakdown Json? // Detailed price items inherited from quotation or project

  // Payment information
  paymentInfo String // Bank details, payment methods

  // Indonesian compliance
  materaiRequired  Boolean   @default(false) // Auto-calculated if > 5M IDR
  materaiApplied   Boolean   @default(false) // User confirms materai applied
  materaiAppliedAt DateTime? // When materai was applied
  materaiAppliedBy String? // User who applied materai
  materaiAmount    Decimal?  @db.Decimal(12, 2) // Amount of stamp duty

  // Terms and signature
  terms     String?
  signature String? // Digital signature or file path

  // Status management
  status InvoiceStatus @default(DRAFT)

  // User tracking
  createdBy String
  user      User   @relation("InvoiceCreator", fields: [createdBy], references: [id], onDelete: Restrict)

  // Payment audit fields (RBAC)
  markedPaidBy String?
  paidMarker   User?     @relation("InvoicePaidMarker", fields: [markedPaidBy], references: [id], onDelete: SetNull)
  markedPaidAt DateTime?

  // Accounting Integration
  journalEntryId   String? // Journal entry when invoice sent (AR/Revenue)
  paymentJournalId String? // Journal entry when invoice paid (Cash/AR)

  // Milestone Integration (Phase 1 Enhancement)
  paymentMilestoneId String? // Which payment milestone is this invoice for?
  paymentMilestone   PaymentMilestone? @relation("PaymentMilestoneInvoices", fields: [paymentMilestoneId], references: [id], onDelete: SetNull)

  projectMilestoneId String? // Which project milestone is this invoice for?
  projectMilestone   ProjectMilestone? @relation("ProjectMilestoneInvoices", fields: [projectMilestoneId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  payments              Payment[]
  businessJourneyEvents BusinessJourneyEvent[]
  documents             Document[]
  expenses              Expense[] // Billable expenses linked to invoice
  allowances            AllowanceForDoubtfulAccounts[]
  deferredRevenues      DeferredRevenue[] // PSAK 72: Deferred revenue entries

  @@index([invoiceNumber])
  @@index([status])
  @@index([clientId])
  @@index([projectId])
  @@index([createdAt])
  @@index([dueDate])
  @@index([materaiRequired])
  @@index([quotationId])
  @@index([paymentMilestoneId]) // Phase 1 Enhancement: milestone lookup
  @@index([projectMilestoneId]) // Phase 1 Enhancement: project milestone lookup
  // Composite indexes for performance optimization - Critical queries
  @@index([clientId, status])
  @@index([clientId, projectId, status]) // Phase 2: Multi-field queries
  @@index([quotationId, status]) // Phase 2: Quotation-based filters
  @@index([status, dueDate])
  @@index([status, createdAt])
  @@index([materaiRequired, totalAmount])
  @@index([materaiRequired, materaiApplied, status])
  @@index([createdAt, status])
  @@map("invoices")
}

// Payment Tracking
model Payment {
  id             String        @id @default(cuid())
  invoiceId      String
  invoice        Invoice       @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  amount         Decimal       @db.Decimal(12, 2)
  paymentDate    DateTime
  paymentMethod  PaymentMethod
  transactionRef String? // Reference from payment gateway
  bankDetails    String? // Bank transfer details
  status         PaymentStatus @default(PENDING)
  confirmedAt    DateTime?

  // Accounting Integration
  journalEntryId String? // Journal entry for this payment

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  businessJourneyEvents BusinessJourneyEvent[]
  expenses              Expense[] // Expense reimbursement payments

  // Indexes for performance optimization
  @@index([invoiceId])
  @@index([status])
  @@index([paymentDate])
  @@index([paymentMethod])
  // Composite indexes for common queries
  @@index([status, paymentDate])
  @@index([invoiceId, status])
  @@map("payments")
}

// Business Journey Tracking
model BusinessJourneyEvent {
  id          String                     @id @default(cuid())
  type        BusinessJourneyEventType
  title       String
  description String
  status      BusinessJourneyEventStatus @default(PENDING)
  amount      Decimal?                   @db.Decimal(12, 2)

  // Entity relationships
  clientId    String?
  client      Client?    @relation(fields: [clientId], references: [id])
  projectId   String?
  project     Project?   @relation(fields: [projectId], references: [id])
  quotationId String?
  quotation   Quotation? @relation(fields: [quotationId], references: [id])
  invoiceId   String?
  invoice     Invoice?   @relation(fields: [invoiceId], references: [id])
  paymentId   String?
  payment     Payment?   @relation(fields: [paymentId], references: [id])

  // Metadata
  metadata BusinessJourneyEventMetadata?

  // User tracking
  createdBy String
  user      User   @relation("BusinessJourneyEventCreator", fields: [createdBy], references: [id], onDelete: Restrict)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
  @@index([status])
  @@index([clientId])
  @@index([projectId])
  @@index([quotationId])
  @@index([invoiceId])
  @@index([createdAt])
  @@index([amount])
  // Composite indexes for business analytics and timeline queries
  @@index([clientId, type, createdAt])
  @@index([clientId, status, createdAt])
  @@index([type, status])
  @@index([status, createdAt])
  @@map("business_journey_events")
}

// Business Journey Event Metadata
model BusinessJourneyEventMetadata {
  id      String               @id @default(cuid())
  eventId String               @unique
  event   BusinessJourneyEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)

  // User information
  userCreated  String
  userModified String?

  // System information
  source   BusinessJourneyEventSource @default(SYSTEM)
  priority BusinessJourneyPriority    @default(MEDIUM)

  // Additional data
  tags             String[] // Array of tags
  relatedDocuments String[] // Array of document IDs
  notes            String?
  ipAddress        String?
  userAgent        String?

  // Indonesian business context
  materaiRequired  Boolean  @default(false)
  materaiAmount    Decimal? @db.Decimal(12, 2)
  complianceStatus String? // Compliance status with Indonesian regulations

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([source])
  @@index([priority])
  @@index([materaiRequired])
  @@map("business_journey_event_metadata")
}

// UX Analytics for Performance Monitoring
model UXMetrics {
  id            String @id @default(cuid())
  componentName String
  eventType     String // 'render', 'interaction', 'error'
  metricName    String // 'load_time', 'interaction_delay', etc.
  value         Float

  // Context
  userId    String?
  sessionId String?
  clientId  String?
  url       String?
  userAgent String?

  // Performance data
  performanceData Json? // Core Web Vitals and other metrics

  createdAt DateTime @default(now())

  @@index([componentName])
  @@index([eventType])
  @@index([metricName])
  @@index([userId])
  @@index([createdAt])
  @@map("ux_metrics")
}

// Audit Trail
model AuditLog {
  id         String   @id @default(cuid())
  action     String // CREATE, UPDATE, DELETE
  entityType String // quotation, invoice, etc.
  entityId   String // ID of the affected entity
  oldValues  Json? // Previous state
  newValues  Json? // New state
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@map("audit_logs")
}

// Enums
enum UserRole {
  // New roles (production-ready RBAC)
  SUPER_ADMIN // Owner/IT Admin - Full system access
  FINANCE_MANAGER // Financial Controller - Approve transactions
  ACCOUNTANT // Bookkeeper - Accounting ops, no approvals
  PROJECT_MANAGER // Operations - CRUD ops, submit for approval
  STAFF // Basic User - Create drafts, own data only
  VIEWER // Read-Only - View data only

  // Legacy roles (backward compatibility)
  ADMIN // Maps to SUPER_ADMIN
  USER // Maps to STAFF
}

// Dynamic Project Type Configuration
model ProjectTypeConfig {
  id          String  @id @default(cuid())
  code        String  @unique // Unique code like "PRODUCTION", "SOCIAL_MEDIA"
  name        String // Display name like "Production Work"
  description String? // Optional description
  prefix      String // Prefix for project numbers like "PH", "SM"
  color       String  @default("#1890ff") // UI color for the type
  isDefault   Boolean @default(false) // Is this the default type
  isActive    Boolean @default(true) // Is this type active
  sortOrder   Int     @default(0) // Sort order for display

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  projects Project[]

  @@index([code])
  @@index([isActive])
  @@index([sortOrder])
  @@map("project_type_configs")
}

enum ProjectStatus {
  PLANNING
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum QuotationStatus {
  DRAFT
  SENT
  APPROVED
  DECLINED
  REVISED
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

enum PaymentType {
  FULL_PAYMENT // Pay in full upon completion
  MILESTONE_BASED // Pay per milestone (termin pembayaran)
  ADVANCE_PAYMENT // Advance + final payment
  CUSTOM // Custom payment structure
}

enum PaymentMethod {
  BANK_TRANSFER
  CASH
  OTHER
}

enum Currency {
  IDR // Indonesian Rupiah (default)
  USD // US Dollar
  USDT // Tether (USDT) - Stablecoin cryptocurrency
}

enum PaymentStatus {
  PENDING
  CONFIRMED
  FAILED
  REFUNDED
}

// Business Journey Enums
enum BusinessJourneyEventType {
  CLIENT_CREATED
  PROJECT_STARTED
  QUOTATION_DRAFT
  QUOTATION_SENT
  QUOTATION_APPROVED
  QUOTATION_DECLINED
  QUOTATION_REVISED
  INVOICE_GENERATED
  INVOICE_SENT
  PAYMENT_RECEIVED
  PAYMENT_OVERDUE
  MATERAI_REQUIRED
  MATERAI_APPLIED
}

enum BusinessJourneyEventStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
  REQUIRES_ATTENTION
}

enum BusinessJourneyEventSource {
  SYSTEM
  USER
  API
  WEBHOOK
}

enum BusinessJourneyPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// Settings Models
model UserPreferences {
  id                 String  @id @default(cuid())
  userId             String  @unique
  user               User    @relation(fields: [userId], references: [id])
  timezone           String  @default("Asia/Jakarta")
  language           String  @default("id-ID")
  currency           String  @default("IDR")
  emailNotifications Boolean @default(true)
  pushNotifications  Boolean @default(true)
  theme              String  @default("light")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_preferences")
}

model CompanySettings {
  id          String  @id @default("default")
  companyName String  @default("PT Teknologi Indonesia")
  address     String?
  phone       String?
  email       String?
  website     String?
  taxNumber   String? // NPWP
  currency    String  @default("IDR")

  // Bank accounts
  bankBCA     String?
  bankMandiri String?
  bankBNI     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("company_settings")
}

model SystemSettings {
  id                  String  @id @default("default")
  defaultPaymentTerms String  @default("NET 30")
  materaiThreshold    Int     @default(5000000)
  invoicePrefix       String  @default("INV-")
  quotationPrefix     String  @default("QT-")
  autoBackup          Boolean @default(true)
  backupFrequency     String  @default("daily")
  backupTime          String  @default("02:00")
  autoMateraiReminder Boolean @default(true)
  defaultCurrency     String  @default("IDR")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("system_settings")
}

// Feature Flags System
model FeatureFlag {
  id             String    @id @default(cuid())
  name           String    @unique
  description    String?
  enabled        Boolean   @default(false)
  globalEnabled  Boolean   @default(false)
  targetUsers    String[] // Array of user IDs
  targetGroups   String[] // Array of group names
  rules          Json? // Additional targeting rules
  expiresAt      DateTime?
  disabledReason String?
  disabledAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  events FeatureFlagEvent[]

  @@map("feature_flags")
}

model FeatureFlagEvent {
  id        String      @id @default(cuid())
  flagId    String
  flag      FeatureFlag @relation(fields: [flagId], references: [id])
  userId    String?
  eventType String // 'enabled', 'disabled', 'viewed', 'clicked'
  metadata  Json?

  createdAt DateTime @default(now())

  @@index([flagId])
  @@index([userId])
  @@index([eventType])
  @@map("feature_flag_events")
}

// Document Management
model Document {
  id               String           @id @default(cuid())
  fileName         String
  originalFileName String
  filePath         String
  fileSize         Int // Size in bytes
  mimeType         String
  category         DocumentCategory @default(OTHER)
  description      String?

  // Entity relationships - documents can be attached to invoices, quotations, or projects
  invoiceId   String?
  invoice     Invoice?   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  quotationId String?
  quotation   Quotation? @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  projectId   String?
  project     Project?   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // User tracking
  uploadedBy String
  uploadedAt DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([invoiceId])
  @@index([quotationId])
  @@index([projectId])
  @@index([category])
  @@index([mimeType])
  @@index([uploadedAt])
  @@map("documents")
}

enum DocumentCategory {
  SUPPORTING_DOCUMENT
  CONTRACT
  RECEIPT
  INVOICE_ATTACHMENT
  OTHER
}

// ============================================
// PROPERTY MANAGEMENT SYSTEM
// ============================================

// Asset Management
model Asset {
  id             String  @id @default(cuid())
  assetCode      String  @unique
  name           String
  category       String // Camera, Lens, Lighting, Audio, Drone, Computer, etc.
  subcategory    String?
  manufacturer   String?
  model          String?
  serialNumber   String?
  specifications Json?

  // Purchase information
  purchaseDate       DateTime
  purchasePrice      Decimal   @db.Decimal(15, 2)
  supplier           String?
  invoiceNumber      String?
  warrantyExpiration DateTime?

  // Future depreciation fields (kept for compatibility)
  currentValue     Decimal? @db.Decimal(15, 2)
  residualValue    Decimal? @db.Decimal(15, 2)
  usefulLifeYears  Int?
  notesFinancial   String?  @db.Text

  // Status and condition
  status    AssetStatus    @default(AVAILABLE)
  condition AssetCondition @default(GOOD)
  location  String?

  // Media and tracking
  photos    String[] // Array of file paths
  documents String[] // Array of file paths
  qrCode    String?  @db.Text // Base64 QR code or file path
  rfidTag   String?
  tags      String[] // Array of tags for search
  notes     String?  @db.Text

  // Audit fields
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String?

  // Relations
  createdBy             User?                   @relation("CreatedAssets", fields: [createdById], references: [id], onDelete: SetNull)
  reservations          AssetReservation[]
  maintenanceRecords    MaintenanceRecord[]
  maintenanceSchedules  MaintenanceSchedule[]
  kitItems              AssetKitItem[]
  projectUsage          ProjectEquipmentUsage[]
  depreciationSchedules DepreciationSchedule[]
  depreciationEntries   DepreciationEntry[]

  // ===== PURCHASE-TO-PAY INTEGRATION =====

  // Vendor Integration
  vendorId String?
  vendor   Vendor? @relation(fields: [vendorId], references: [id])

  // Purchase Workflow Links
  purchaseOrderId String?
  purchaseOrder   PurchaseOrder? @relation(fields: [purchaseOrderId], references: [id])

  goodsReceiptId String?
  goodsReceipt   GoodsReceipt? @relation(fields: [goodsReceiptId], references: [id])

  vendorInvoiceId String?
  vendorInvoice   VendorInvoice? @relation(fields: [vendorInvoiceId], references: [id])

  // Relations
  poItems PurchaseOrderItem[]

  @@index([assetCode])
  @@index([category])
  @@index([status])
  @@index([condition])
  @@index([createdById])
  @@index([createdAt])
  // Composite indexes for common queries
  @@index([category, status])
  @@index([status, condition])
  @@map("assets")
}

// Asset Reservation System
model AssetReservation {
  id        String            @id @default(cuid())
  assetId   String
  userId    String
  projectId String?
  startDate DateTime
  endDate   DateTime
  purpose   String            @db.Text
  status    ReservationStatus @default(PENDING)
  notes     String?           @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  asset   Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)
  user    User     @relation("AssetReservationUser", fields: [userId], references: [id], onDelete: SetNull)
  project Project? @relation(fields: [projectId], references: [id])

  @@index([assetId])
  @@index([userId])
  @@index([projectId])
  @@index([status])
  @@index([startDate])
  @@index([endDate])
  // Composite indexes for conflict detection
  @@index([assetId, startDate, endDate])
  @@index([assetId, status])
  @@map("asset_reservations")
}

// Maintenance Schedule (Preventive Maintenance)
model MaintenanceSchedule {
  id                  String               @id @default(cuid())
  assetId             String
  maintenanceType     String // "Cleaning", "Calibration", "Inspection", etc.
  frequency           MaintenanceFrequency
  lastMaintenanceDate DateTime?
  nextMaintenanceDate DateTime
  isActive            Boolean              @default(true)
  notes               String?              @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  asset Asset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([assetId])
  @@index([nextMaintenanceDate])
  @@index([isActive])
  // Composite indexes for maintenance alerts
  @@index([isActive, nextMaintenanceDate])
  @@map("maintenance_schedules")
}

// Maintenance Record (Actual Maintenance Performed)
model MaintenanceRecord {
  id                  String    @id @default(cuid())
  assetId             String
  maintenanceType     String
  performedDate       DateTime
  performedBy         String? // Technician name or company
  cost                Decimal?  @db.Decimal(15, 2)
  description         String    @db.Text
  partsReplaced       Json? // Array of parts replaced
  nextMaintenanceDate DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  asset Asset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([assetId])
  @@index([performedDate])
  @@index([maintenanceType])
  @@map("maintenance_records")
}

// Asset Kit (Equipment Bundles)
model AssetKit {
  id          String  @id @default(cuid())
  name        String
  description String? @db.Text
  isActive    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  items AssetKitItem[]

  @@index([isActive])
  @@map("asset_kits")
}

// Asset Kit Items (Many-to-Many through table)
model AssetKitItem {
  id       String @id @default(cuid())
  kitId    String
  assetId  String
  quantity Int    @default(1)

  // Relations
  kit   AssetKit @relation(fields: [kitId], references: [id], onDelete: Cascade)
  asset Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@unique([kitId, assetId])
  @@index([kitId])
  @@index([assetId])
  @@map("asset_kit_items")
}

// Project Equipment Usage Tracking
model ProjectEquipmentUsage {
  id         String    @id @default(cuid())
  projectId  String?
  assetId    String
  startDate  DateTime // When asset was checked out
  endDate    DateTime? // Expected return date
  returnDate DateTime? // Actual return date
  condition  String? // Condition on return
  notes      String?   @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  project Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  asset   Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([assetId])
  @@index([startDate])
  @@index([returnDate])
  // Composite indexes for usage analytics
  @@index([assetId, startDate])
  @@index([projectId, assetId])
  @@map("project_equipment_usage")
}

// Property Management Enums
enum AssetStatus {
  AVAILABLE
  RESERVED
  CHECKED_OUT
  IN_MAINTENANCE
  BROKEN
  RETIRED
}

enum AssetCondition {
  EXCELLENT
  GOOD
  FAIR
  POOR
  BROKEN
}

enum ReservationStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum MaintenanceFrequency {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  SEMI_ANNUAL
  ANNUAL
  AS_NEEDED
}

// ============================================
// EXPENSE MANAGEMENT SYSTEM
// ============================================

// Main Expense Model - Indonesian Compliant
model Expense {
  id            String @id @default(cuid())
  expenseNumber String @unique // EXP-2025-0001

  // ===== INDONESIAN COMPLIANCE FIELDS =====

  // Bukti Pengeluaran Number
  buktiPengeluaranNumber String @unique // BKK-2025-0001

  // PSAK Chart of Accounts
  accountCode   String // 6-1010, 6-2050, 8-1010
  accountName   String // Indonesian account name
  accountNameEn String? // English account name

  // Expense Classification (for Income Statement)
  expenseClass ExpenseClass // SELLING, GENERAL_ADMIN, OTHER

  // Bilingual Descriptions
  description   String // Primary description
  descriptionId String? // Indonesian description (Uraian)
  descriptionEn String? // English description

  // ===== TAX COMPLIANCE FIELDS =====

  // PPN (VAT) - Indonesian 2025 Rates
  ppnRate       Decimal     @default(0.1200) @db.Decimal(5, 4) // 12% or 11%
  ppnAmount     Decimal     @db.Decimal(12, 2)
  ppnCategory   PPNCategory @default(CREDITABLE)
  isLuxuryGoods Boolean     @default(false) // For 12% vs 11% rate

  // E-Faktur Integration
  eFakturNSFP         String? // Nomor Seri Faktur Pajak: 010.123-25.12345678
  eFakturQRCode       String?       @db.Text // QR Code data
  eFakturApprovalCode String? // DGT approval code
  eFakturStatus       EFakturStatus @default(NOT_REQUIRED)
  eFakturValidatedAt  DateTime?

  // Withholding Tax (PPh)
  withholdingTaxType   WithholdingTaxType? // PPH23, PPH4_2, PPH15
  withholdingTaxRate   Decimal?            @db.Decimal(5, 4) // 0.02, 0.15, etc.
  withholdingTaxAmount Decimal?            @db.Decimal(12, 2)
  buktiPotongNumber    String? // Withholding tax evidence number
  buktiPotongDate      DateTime?

  // ===== VENDOR INFORMATION (Indonesian Format) =====

  vendorName        String // Nama Vendor
  vendorNPWP        String? // NPWP (Tax ID): 01.234.567.8-901.000
  vendorAddress     String? // Alamat
  vendorPhone       String?
  vendorBank        String? // Bank name
  vendorAccountNo   String? // Bank account number
  vendorAccountName String? // Account holder name

  // ===== AMOUNT BREAKDOWN (Indonesian Tax Format) =====

  grossAmount       Decimal  @db.Decimal(12, 2) // Jumlah Bruto (before PPN)
  withholdingAmount Decimal? @db.Decimal(12, 2) // PPh withheld
  netAmount         Decimal  @db.Decimal(12, 2) // Net payment (Jumlah Bersih)
  totalAmount       Decimal  @db.Decimal(12, 2) // Gross + PPN (for display)

  // ===== STANDARD FIELDS =====

  expenseDate DateTime // Tanggal Pengeluaran
  currency    String   @default("IDR")

  // Categorization
  categoryId      String
  category        ExpenseCategory @relation(fields: [categoryId], references: [id])
  tags            String[] // Custom tags
  isTaxDeductible Boolean         @default(true) // Most business expenses are

  // Relationships
  userId String // Expense submitter
  user   User   @relation("ExpenseSubmitter", fields: [userId], references: [id], onDelete: Restrict)

  projectId String?
  project   Project? @relation(fields: [projectId], references: [id])

  clientId String?
  client   Client? @relation(fields: [clientId], references: [id])

  // Billable Tracking
  isBillable     Boolean  @default(false)
  billableAmount Decimal? @db.Decimal(12, 2)
  invoiceId      String? // If converted to invoice item
  invoice        Invoice? @relation(fields: [invoiceId], references: [id])

  // Approval Workflow
  status          ExpenseStatus @default(DRAFT)
  submittedAt     DateTime?
  approvedAt      DateTime?
  approvedBy      String?
  approver        User?         @relation("ExpenseApprover", fields: [approvedBy], references: [id])
  rejectedAt      DateTime?
  rejectionReason String?       @db.Text

  // Payment Tracking
  paymentStatus    ExpensePaymentStatus @default(UNPAID)
  paidAt           DateTime?
  paymentMethod    String? // BANK_TRANSFER, CASH, etc.
  paymentReference String? // Bank transfer reference
  paymentId        String?
  payment          Payment?             @relation(fields: [paymentId], references: [id])

  // Accounting Integration
  journalEntryId   String? // Journal entry when expense submitted (Expense/AP)
  paymentJournalId String? // Journal entry when expense paid (AP/Cash)

  // Notes
  notes         String? @db.Text
  notesId       String? @db.Text // Indonesian notes
  notesEn       String? @db.Text // English notes
  receiptNumber String? // Merchant receipt number
  merchantName  String? // Merchant name (if different from vendor)
  location      String? // Location of expense

  // Documents (Receipts, E-Faktur, Supporting Docs)
  documents ExpenseDocument[]

  // Audit Trail
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  // Relations
  approvalHistory ExpenseApprovalHistory[]
  comments        ExpenseComment[]
  costAllocations ProjectCostAllocation[] // PSAK 57: Project cost allocation

  // Labor Entry Integration (expenses created from labor entries)
  laborEntries LaborEntry[] @relation("ExpenseLaborEntries")

  // ===== PURCHASE-TO-PAY INTEGRATION =====

  // Purchase Type & Source
  purchaseType   PurchaseType   @default(DIRECT)
  purchaseSource PurchaseSource @default(MANUAL)

  // Vendor Integration (FK to Vendor master)
  vendorId String?
  vendor   Vendor? @relation(fields: [vendorId], references: [id])

  // Purchase Workflow Links
  purchaseOrderId String?
  purchaseOrder   PurchaseOrder? @relation(fields: [purchaseOrderId], references: [id])

  vendorInvoiceId String?
  vendorInvoice   VendorInvoice? @relation(fields: [vendorInvoiceId], references: [id])

  accountsPayableId String?          @unique
  accountsPayable   AccountsPayable?

  // Payment Terms
  dueDate DateTime? // Actual due date (not calculated)

  // Keep existing vendorName and vendorNPWP for legacy data
  // vendorName       String    (existing - line 997)
  // vendorNPWP       String?   (existing - line 998)

  // Indexes for Performance
  @@index([expenseNumber])
  @@index([buktiPengeluaranNumber])
  @@index([accountCode])
  @@index([expenseClass])
  @@index([status])
  @@index([userId])
  @@index([projectId])
  @@index([clientId])
  @@index([categoryId])
  @@index([expenseDate])
  @@index([eFakturNSFP])
  @@index([ppnCategory])
  @@index([status, userId])
  @@index([projectId, status])
  @@index([paymentStatus])
  @@index([createdAt])
  // Purchase-to-Pay indexes
  @@index([vendorId])
  @@index([vendorId, status]) // Phase 2: Vendor expense filtering
  @@index([projectId, categoryId]) // Phase 2: Project cost breakdown
  @@index([status, expenseDate]) // Phase 2: Date-based status queries
  @@index([purchaseOrderId])
  @@index([vendorInvoiceId])
  @@index([purchaseType])
  @@index([purchaseSource])
  @@index([dueDate])
  @@map("expenses")
}

// Expense Category (PSAK-Aligned)
model ExpenseCategory {
  id   String @id @default(cuid())
  code String @unique // OFFICE_RENT, ADVERTISING, etc.

  // PSAK Account Code
  accountCode  String // 6-1010, 6-2050, 8-1010
  expenseClass ExpenseClass // SELLING, GENERAL_ADMIN, OTHER

  // Bilingual Names
  name          String // English name
  nameId        String // Indonesian name (e.g., "Sewa Kantor")
  description   String? // English description
  descriptionId String? // Indonesian description

  // Hierarchy Support
  parentId String?
  parent   ExpenseCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children ExpenseCategory[] @relation("CategoryHierarchy")

  // Tax Configuration
  defaultPPNRate     Decimal             @default(0.1200) @db.Decimal(5, 4) // 12%
  isLuxuryGoods      Boolean             @default(false)
  withholdingTaxType WithholdingTaxType? @default(NONE)
  withholdingTaxRate Decimal?            @db.Decimal(5, 4)

  // UI Settings
  icon  String? // Icon name for UI
  color String  @default("#1890ff") // Display color

  // Business Rules
  isActive         Boolean @default(true)
  isBillable       Boolean @default(false) // Default billable setting
  requiresReceipt  Boolean @default(true)
  requiresEFaktur  Boolean @default(true) // Require e-Faktur validation
  approvalRequired Boolean @default(true)
  sortOrder        Int     @default(0)

  // Relations
  expenses Expense[]
  budgets  ExpenseBudget[]

  // Purchase-to-Pay Integration
  purchaseOrderItems PurchaseOrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
  @@index([accountCode])
  @@index([expenseClass])
  @@index([parentId])
  @@index([isActive])
  @@map("expense_categories")
}

// Expense Approval History
model ExpenseApprovalHistory {
  id        String  @id @default(cuid())
  expenseId String
  expense   Expense @relation(fields: [expenseId], references: [id], onDelete: Cascade)

  action   ExpenseApprovalAction // SUBMITTED, APPROVED, REJECTED, RECALLED
  actionBy String
  user     User                  @relation("ExpenseApprovalUser", fields: [actionBy], references: [id], onDelete: SetNull)

  previousStatus ExpenseStatus
  newStatus      ExpenseStatus

  comments   String? @db.Text
  commentsId String? @db.Text // Indonesian comments
  commentsEn String? @db.Text // English comments

  actionDate DateTime @default(now())

  @@index([expenseId])
  @@index([actionBy])
  @@index([actionDate])
  @@map("expense_approval_history")
}

// Expense Comments
model ExpenseComment {
  id        String  @id @default(cuid())
  expenseId String
  expense   Expense @relation(fields: [expenseId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation("ExpenseCommentUser", fields: [userId], references: [id], onDelete: SetNull)

  comment   String  @db.Text
  commentId String? @db.Text // Indonesian comment
  commentEn String? @db.Text // English comment

  isInternal Boolean @default(false) // Internal notes vs public comments

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([expenseId])
  @@index([userId])
  @@index([createdAt])
  @@map("expense_comments")
}

// Expense Budget Tracking
model ExpenseBudget {
  id            String  @id @default(cuid())
  name          String
  nameId        String? // Indonesian name
  description   String?
  descriptionId String? // Indonesian description

  // Budget Scope
  categoryId String?
  category   ExpenseCategory? @relation(fields: [categoryId], references: [id])

  projectId String?
  project   Project? @relation(fields: [projectId], references: [id])

  userId String? // User-specific budget
  user   User?   @relation("UserExpenseBudget", fields: [userId], references: [id])

  // Budget Amounts
  amount    Decimal      @db.Decimal(12, 2)
  period    BudgetPeriod // MONTHLY, QUARTERLY, YEARLY, CUSTOM
  startDate DateTime
  endDate   DateTime

  // Tracking
  spent     Decimal @default(0) @db.Decimal(12, 2)
  remaining Decimal @db.Decimal(12, 2)

  // Alerts
  alertThreshold Int     @default(80) // Alert at 80% spent
  alertSent      Boolean @default(false)

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([categoryId])
  @@index([projectId])
  @@index([userId])
  @@index([startDate, endDate])
  @@index([isActive])
  @@map("expense_budgets")
}

// Expense Documents (separate from general Document to avoid circular dependencies)
model ExpenseDocument {
  id               String                  @id @default(cuid())
  fileName         String
  originalFileName String
  filePath         String
  fileSize         Int // Size in bytes
  mimeType         String
  category         ExpenseDocumentCategory @default(OTHER)
  description      String?

  // Expense relationship
  expenseId String
  expense   Expense @relation(fields: [expenseId], references: [id], onDelete: Cascade)

  // User tracking
  uploadedBy String
  uploadedAt DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([expenseId])
  @@index([category])
  @@index([mimeType])
  @@index([uploadedAt])
  @@map("expense_documents")
}

// ============================================
// EXPENSE ENUMS
// ============================================

enum ExpenseStatus {
  DRAFT // Being created
  SUBMITTED // Submitted for approval
  APPROVED // Approved by manager
  REJECTED // Rejected
  PAID // Reimbursement paid
  CANCELLED // Cancelled by submitter
}

enum ExpensePaymentStatus {
  UNPAID // Not yet paid
  PENDING // Payment in progress
  PAID // Payment completed
  PARTIAL // Partially paid
}

enum ExpenseApprovalAction {
  SUBMITTED
  APPROVED
  REJECTED
  RECALLED // Submitter withdrew submission
  PAYMENT_REQUESTED
  PAYMENT_COMPLETED
}

enum BudgetPeriod {
  MONTHLY
  QUARTERLY
  YEARLY
  CUSTOM
}

// ===== INDONESIAN COMPLIANCE ENUMS =====

enum ExpenseClass {
  COGS // Cost of Goods Sold / Harga Pokok Penjualan (5-xxxx)
  SELLING // Beban Penjualan (6-1xxx)
  GENERAL_ADMIN // Beban Administrasi & Umum (6-2xxx)
  OTHER // Beban Lain-Lain (8-xxxx)
  LABOR_COST // Biaya Tenaga Kerja (6-2010) - Generated from labor entries
}

enum PPNCategory {
  CREDITABLE // PPN Masukan (can credit against output VAT)
  NON_CREDITABLE // Cannot be credited
  EXEMPT // VAT-exempt
  ZERO_RATED // 0% VAT (exports)
}

enum EFakturStatus {
  NOT_REQUIRED // Not required for this expense
  PENDING // Awaiting e-Faktur upload
  UPLOADED // Uploaded, awaiting validation
  VALID // Validated by DGT
  INVALID // Invalid e-Faktur
  EXPIRED // e-Faktur expired
}

enum WithholdingTaxType {
  PPH23 // PPh Pasal 23 (services)
  PPH4_2 // PPh Pasal 4(2) (final)
  PPH15 // PPh Pasal 15 (specific activities)
  NONE // No withholding tax
}

enum ExpenseDocumentCategory {
  RECEIPT // E-Faktur or receipt
  SUPPORTING_DOC // Supporting document
  CONTRACT // Contract
  BUKTI_POTONG // Withholding tax evidence
  OTHER // Other documents
}

// ============================================
// ACCOUNTING SYSTEM (PSAK COMPLIANT)
// ============================================

// Chart of Accounts (Bagan Akun)
model ChartOfAccounts {
  id             String      @id @default(cuid())
  code           String      @unique // 1-1010, 4-1010, 6-1010
  name           String // English name
  nameId         String // Indonesian name
  accountType    AccountType // ASSET, LIABILITY, EQUITY, REVENUE, EXPENSE
  accountSubType String // CURRENT_ASSET, FIXED_ASSET, etc.
  normalBalance  BalanceType // DEBIT or CREDIT

  // Hierarchy
  parentId String?
  parent   ChartOfAccounts?  @relation("AccountHierarchy", fields: [parentId], references: [id])
  children ChartOfAccounts[] @relation("AccountHierarchy")

  // Tax Configuration
  isControlAccount Boolean @default(false) // AR, AP, Cash
  isTaxAccount     Boolean @default(false) // PPN, PPh
  taxType          String? // PPN_IN, PPN_OUT, PPH23, PPH4_2

  // Multi-Currency Support (2025 Enhancement)
  currency          Currency @default(IDR) // Account currency (for bank/cash accounts)
  isCurrencyAccount Boolean  @default(false) // True for cash/bank accounts that hold specific currency

  // Status
  isActive        Boolean @default(true)
  isSystemAccount Boolean @default(false) // Cannot be deleted
  description     String?
  descriptionId   String?

  // Relations
  journalLineItems JournalLineItem[]
  ledgerEntries    GeneralLedger[]
  accountBalances  AccountBalance[]

  // Cash Transaction Relations
  cashTransactionsCash   CashTransaction[] @relation("CashTransactionCashAccount")
  cashTransactionsOffset CashTransaction[] @relation("CashTransactionOffsetAccount")

  // Bank Transfer Relations
  bankTransfersFrom BankTransfer[] @relation("BankTransferFromAccount")
  bankTransfersTo   BankTransfer[] @relation("BankTransferToAccount")

  // Bank Reconciliation Relations
  bankReconciliations BankReconciliation[] @relation("BankReconciliationAccount")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
  @@index([accountType])
  @@index([isActive])
  @@index([parentId])
  @@map("chart_of_accounts")
}

// Journal Entries (Jurnal Umum)
model JournalEntry {
  id          String    @id @default(cuid())
  entryNumber String    @unique // JE-2025-10-0001
  entryDate   DateTime
  postingDate DateTime? // When posted to ledger

  // Description
  description   String
  descriptionId String?
  descriptionEn String?

  // Transaction Reference
  transactionType TransactionType // INVOICE, PAYMENT, EXPENSE, etc.
  transactionId   String // ID of invoice, payment, expense, etc.

  // Source Document
  documentNumber String? // Invoice number, expense number
  documentDate   DateTime?

  // Status
  status   JournalStatus @default(DRAFT)
  isPosted Boolean       @default(false)
  postedAt DateTime?
  postedBy String?

  // Fiscal Period
  fiscalPeriodId String?
  fiscalPeriod   FiscalPeriod? @relation(fields: [fiscalPeriodId], references: [id])

  // Reversal
  isReversing      Boolean        @default(false)
  reversedEntryId  String?
  reversedEntry    JournalEntry?  @relation("JournalReversal", fields: [reversedEntryId], references: [id])
  reversingEntries JournalEntry[] @relation("JournalReversal")

  // User Tracking
  createdBy String
  updatedBy String?

  // Relations
  lineItems           JournalLineItem[]
  ledgerEntries       GeneralLedger[]
  depreciationEntries DepreciationEntry[]
  eclProvisions       AllowanceForDoubtfulAccounts[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([entryNumber])
  @@index([entryDate])
  @@index([status])
  @@index([transactionType])
  @@index([transactionId])
  @@index([fiscalPeriodId])
  @@index([isPosted])
  @@map("journal_entries")
}

// Journal Line Items (Detail Jurnal)
model JournalLineItem {
  id             String       @id @default(cuid())
  journalEntryId String
  journalEntry   JournalEntry @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)

  lineNumber Int // 1, 2, 3...

  // Account
  accountId String
  account   ChartOfAccounts @relation(fields: [accountId], references: [id])

  // Amount
  debit  Decimal @default(0) @db.Decimal(15, 2)
  credit Decimal @default(0) @db.Decimal(15, 2)

  // Description
  description   String?
  descriptionId String?

  // Dimensions (for reporting)
  projectId    String?
  clientId     String?
  departmentId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([journalEntryId])
  @@index([accountId])
  @@index([projectId])
  @@index([clientId])
  @@map("journal_line_items")
}

// General Ledger (Buku Besar)
model GeneralLedger {
  id String @id @default(cuid())

  // Account
  accountId String
  account   ChartOfAccounts @relation(fields: [accountId], references: [id])

  // Transaction Details
  entryDate   DateTime
  postingDate DateTime

  // Journal Reference
  journalEntryId     String
  journalEntry       JournalEntry @relation(fields: [journalEntryId], references: [id])
  journalEntryNumber String
  lineNumber         Int

  // Amount
  debit   Decimal @default(0) @db.Decimal(15, 2)
  credit  Decimal @default(0) @db.Decimal(15, 2)
  balance Decimal @db.Decimal(15, 2) // Running balance

  // Description
  description   String
  descriptionId String?

  // Transaction Reference
  transactionType TransactionType
  transactionId   String
  documentNumber  String?

  // Dimensions
  projectId      String?
  clientId       String?
  fiscalPeriodId String?

  createdAt DateTime @default(now())

  @@index([accountId])
  @@index([entryDate])
  @@index([postingDate])
  @@index([journalEntryId])
  @@index([transactionType])
  @@index([fiscalPeriodId])
  @@index([projectId])
  @@index([clientId])
  // Phase 2: Composite indexes for critical accounting queries
  @@index([accountId, postingDate])
  @@index([accountId, fiscalPeriodId])
  @@map("general_ledger")
}

// Account Balances (Saldo Akun)
model AccountBalance {
  id String @id @default(cuid())

  // Account
  accountId String
  account   ChartOfAccounts @relation(fields: [accountId], references: [id])

  // Period
  fiscalPeriodId String
  fiscalPeriod   FiscalPeriod @relation(fields: [fiscalPeriodId], references: [id])

  // Balances
  beginningBalance Decimal @default(0) @db.Decimal(15, 2)
  debitTotal       Decimal @default(0) @db.Decimal(15, 2)
  creditTotal      Decimal @default(0) @db.Decimal(15, 2)
  endingBalance    Decimal @default(0) @db.Decimal(15, 2)

  // Status
  isClosed Boolean   @default(false)
  closedAt DateTime?

  lastUpdated DateTime @updatedAt

  @@unique([accountId, fiscalPeriodId])
  @@index([accountId])
  @@index([fiscalPeriodId])
  @@index([isClosed])
  @@map("account_balances")
}

// Fiscal Periods (Periode Fiskal)
model FiscalPeriod {
  id         String     @id @default(cuid())
  name       String // "January 2025", "Q1 2025"
  code       String     @unique // "2025-01", "2025-Q1"
  periodType PeriodType // MONTHLY, QUARTERLY, YEARLY

  startDate DateTime
  endDate   DateTime

  // Status
  status   PeriodStatus @default(OPEN)
  isActive Boolean      @default(true)

  // Closing
  closedAt     DateTime?
  closedBy     String?
  closingNotes String?

  // Relations
  journalEntries      JournalEntry[]
  accountBalances     AccountBalance[]
  depreciationEntries DepreciationEntry[]
  eclProvisions       AllowanceForDoubtfulAccounts[]
  deferredRevenues    DeferredRevenue[] // PSAK 72: Deferred revenue entries
  workInProgress      WorkInProgress[] // PSAK 57: WIP tracking

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
  @@index([status])
  @@index([startDate])
  @@index([endDate])
  @@map("fiscal_periods")
}

// Financial Statements (Cache for Reports)
model FinancialStatement {
  id            String        @id @default(cuid())
  statementType StatementType

  // Period
  fiscalPeriodId String
  startDate      DateTime
  endDate        DateTime

  // Data (JSON for flexibility)
  data Json

  // Metadata
  generatedAt DateTime @default(now())
  generatedBy String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([statementType])
  @@index([fiscalPeriodId])
  @@index([startDate, endDate])
  @@map("financial_statements")
}

// ============================================
// ACCOUNTING ENUMS
// ============================================

enum AccountType {
  ASSET // 1-xxxx
  LIABILITY // 2-xxxx
  EQUITY // 3-xxxx
  REVENUE // 4-xxxx
  EXPENSE // 6-xxxx, 8-xxxx
}

enum BalanceType {
  DEBIT
  CREDIT
}

enum TransactionType {
  INVOICE_SENT // Debit AR, Credit Revenue
  INVOICE_PAID // Debit Cash, Credit AR
  EXPENSE_SUBMITTED // Debit Expense, Credit AP
  EXPENSE_PAID // Debit AP, Credit Cash
  PAYMENT_RECEIVED // Debit Cash, Credit AR
  PAYMENT_MADE // Debit AP, Credit Cash
  DEPRECIATION // Debit Depreciation Expense, Credit Accumulated Depreciation
  ADJUSTMENT // Manual adjustment
  CLOSING // Period closing entry
  OPENING // Period opening entry

  // Cash Management
  CASH_RECEIPT // Manual cash receipt (other income) - Debit Cash, Credit Other Income
  CASH_DISBURSEMENT // Manual cash payment (other payments) - Debit Expense/Other, Credit Cash
  BANK_TRANSFER // Inter-account transfer - Debit Cash Account A, Credit Cash Account B

  // Equity Management
  CAPITAL_CONTRIBUTION // Owner investment - Debit Cash, Credit Owner's Equity
  OWNER_DRAWING // Owner withdrawal - Debit Owner's Drawing, Credit Cash

  // ===== PURCHASE-TO-PAY TYPES =====
  PO_APPROVED // PO commitment - DR Expense/Asset, CR PO Commitments
  PO_CANCELLED // Reverse PO commitment
  GOODS_RECEIVED // GR accrual - DR Inventory/Asset, CR GR Accruals
  VENDOR_INVOICE_APPROVED // Final AP recognition - DR Expense/Asset, CR AP
  VENDOR_PAYMENT_MADE // Payment to vendor - DR AP, CR Cash
  PURCHASE_RETURN // Return to vendor - DR AP, CR Expense

  // Bank Reconciliation
  BANK_RECONCILIATION // Bank rec adjustment - Various adjustments
}

enum JournalStatus {
  DRAFT
  POSTED
  VOID
  REVERSED
}

enum PeriodType {
  MONTHLY
  QUARTERLY
  YEARLY
}

enum PeriodStatus {
  OPEN
  CLOSED
  LOCKED
}

enum StatementType {
  INCOME_STATEMENT // Laporan Laba Rugi
  BALANCE_SHEET // Neraca
  CASH_FLOW // Laporan Arus Kas
  TRIAL_BALANCE // Neraca Saldo
  ACCOUNTS_RECEIVABLE // Laporan Piutang
  ACCOUNTS_PAYABLE // Laporan Hutang
}

// ============================================
// CASH MANAGEMENT SYSTEM
// ============================================

// Exchange Rates (Kurs Valuta Asing)
model ExchangeRate {
  id String @id @default(cuid())

  // Currency Pair
  fromCurrency Currency // Base currency (e.g., USD, USDT)
  toCurrency   Currency @default(IDR) // Target currency (usually IDR)

  // Rate Information
  rate          Decimal   @db.Decimal(18, 8) // Exchange rate (e.g., 1 USD = 15,750.50 IDR)
  effectiveDate DateTime // When this rate becomes effective
  expiryDate    DateTime? // When this rate expires (null = current rate)

  // Source
  source      String? // API source, manual entry, etc.
  isAutomatic Boolean @default(false) // Auto-fetched from API
  isActive    Boolean @default(true) // Currently active rate

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String
  updatedBy String?

  @@unique([fromCurrency, toCurrency, effectiveDate])
  @@index([fromCurrency, toCurrency])
  @@index([effectiveDate])
  @@index([isActive])
  @@map("exchange_rates")
}

// Cash Transactions (Transaksi Kas)
model CashTransaction {
  id                String @id @default(cuid())
  transactionNumber String @unique // CSH-R-2025-0001, CSH-D-2025-0001

  // Type: Receipt or Disbursement
  transactionType CashTransactionType // RECEIPT, DISBURSEMENT
  category        CashCategory // SALES, INCOME, EXPENSE, OTHER

  // Transaction Details
  transactionDate DateTime
  amount          Decimal  @db.Decimal(12, 2)

  // Multi-Currency Support (2025 Enhancement)
  currency       Currency @default(IDR) // Transaction currency
  originalAmount Decimal? @db.Decimal(18, 2) // Amount in original currency (if different from IDR)
  exchangeRate   Decimal? @db.Decimal(18, 8) // Exchange rate used (1 USD/USDT = X IDR)
  idrAmount      Decimal  @db.Decimal(15, 2) // Amount in IDR (for accounting/GL posting)

  // Account Information
  cashAccountId String // Which cash/bank account
  cashAccount   ChartOfAccounts @relation("CashTransactionCashAccount", fields: [cashAccountId], references: [id])

  offsetAccountId String // Offsetting account (income/expense)
  offsetAccount   ChartOfAccounts @relation("CashTransactionOffsetAccount", fields: [offsetAccountId], references: [id])

  // Description (Bilingual)
  description   String
  descriptionId String? // Indonesian description
  descriptionEn String? // English description
  reference     String? // External reference number

  // Payment Details
  paymentMethod PaymentMethod @default(CASH)
  checkNumber   String? // For check payments
  bankReference String? // Bank transfer reference

  // Relations
  projectId String?
  clientId  String?

  // Accounting Integration
  journalEntryId String? // Auto-generated journal entry

  // Status
  status CashTransactionStatus @default(DRAFT)

  // Approval (RBAC)
  approvedBy      String?
  approvedAt      DateTime?
  rejectedBy      String?
  rejectedAt      DateTime?
  rejectionReason String?   @db.Text

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String
  updatedBy String?

  // Notes
  notes   String? @db.Text
  notesId String? @db.Text // Indonesian notes

  @@index([transactionNumber])
  @@index([transactionType])
  @@index([category])
  @@index([transactionDate])
  @@index([status])
  @@index([cashAccountId])
  @@index([offsetAccountId])
  @@index([projectId])
  @@index([clientId])
  @@index([createdBy])
  @@index([createdAt])
  @@map("cash_transactions")
}

// ============================================
// CASH MANAGEMENT ENUMS
// ============================================

enum CashTransactionType {
  RECEIPT // Cash in (penerimaan kas)
  DISBURSEMENT // Cash out (pengeluaran kas)
}

enum CashCategory {
  SALES_REVENUE // Sales revenue (pendapatan penjualan)
  SERVICE_REVENUE // Service revenue (pendapatan jasa)
  OTHER_INCOME // Other income (pendapatan lain-lain)
  OPERATING_EXPENSE // Operating expenses (beban operasional)
  ASSET_PURCHASE // Asset purchases (pembelian aset)
  LOAN_REPAYMENT // Loan payments (pembayaran pinjaman)
  OTHER_EXPENSE // Other expenses (beban lain-lain)
}

enum CashTransactionStatus {
  DRAFT // Being created
  SUBMITTED // Submitted for approval
  APPROVED // Approved
  POSTED // Posted to GL
  REJECTED // Rejected
  VOID // Voided
}

// ============================================
// BANK MANAGEMENT & RECONCILIATION
// ============================================

// Bank Transfers (Inter-Account Transfers)
model BankTransfer {
  id             String @id @default(cuid())
  transferNumber String @unique // BTR-2025-01-0001

  // Transfer Details
  transferDate DateTime
  amount       Decimal  @db.Decimal(12, 2)

  // Multi-Currency Support (2025 Enhancement)
  currency       Currency @default(IDR) // Transfer currency
  originalAmount Decimal? @db.Decimal(18, 2) // Amount in original currency
  exchangeRate   Decimal? @db.Decimal(18, 8) // Exchange rate if currency conversion
  idrAmount      Decimal  @db.Decimal(15, 2) // Amount in IDR (for accounting)

  // Account Information
  fromAccountId String // Source cash/bank account
  fromAccount   ChartOfAccounts @relation("BankTransferFromAccount", fields: [fromAccountId], references: [id])

  toAccountId String // Destination cash/bank account
  toAccount   ChartOfAccounts @relation("BankTransferToAccount", fields: [toAccountId], references: [id])

  // Description (Bilingual)
  description   String
  descriptionId String? // Indonesian description
  descriptionEn String? // English description
  reference     String? // External reference number

  // Transfer Fee (if applicable)
  transferFee      Decimal? @db.Decimal(12, 2)
  feeAccountId     String? // Account to charge fee
  feePaymentMethod String? // How fee is paid

  // Transfer Method
  transferMethod   TransferMethod @default(INTERNAL)
  bankReference    String? // Bank confirmation number
  confirmationCode String? // Bank confirmation code

  // Relations
  projectId String?
  clientId  String?

  // Accounting Integration
  journalEntryId String? // Auto-generated journal entry

  // Status
  status BankTransferStatus @default(PENDING)

  // Approval (RBAC)
  approvedBy      String?
  approvedAt      DateTime?
  rejectedBy      String?
  rejectedAt      DateTime?
  rejectionReason String?   @db.Text

  // Completion
  completedAt DateTime?
  completedBy String?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String
  updatedBy String?

  // Notes
  notes   String? @db.Text
  notesId String? @db.Text // Indonesian notes

  @@index([transferNumber])
  @@index([transferDate])
  @@index([status])
  @@index([fromAccountId])
  @@index([toAccountId])
  @@index([projectId])
  @@index([clientId])
  @@index([createdBy])
  @@index([createdAt])
  @@map("bank_transfers")
}

// Bank Reconciliation (Bank Statement Matching)
model BankReconciliation {
  id                   String @id @default(cuid())
  reconciliationNumber String @unique // BRC-2025-01-0001

  // Bank Account
  bankAccountId String // Bank account being reconciled
  bankAccount   ChartOfAccounts @relation("BankReconciliationAccount", fields: [bankAccountId], references: [id])

  // Period
  statementDate   DateTime // Bank statement date
  periodStartDate DateTime // Reconciliation period start
  periodEndDate   DateTime // Reconciliation period end

  // Balances
  bookBalanceStart Decimal @db.Decimal(15, 2) // Book balance at start
  bookBalanceEnd   Decimal @db.Decimal(15, 2) // Book balance at end
  statementBalance Decimal @db.Decimal(15, 2) // Bank statement ending balance

  // Reconciliation Items
  depositsInTransit Decimal @default(0) @db.Decimal(15, 2) // Deposits not yet on statement
  outstandingChecks Decimal @default(0) @db.Decimal(15, 2) // Checks not yet cleared
  bankCharges       Decimal @default(0) @db.Decimal(15, 2) // Bank charges not yet recorded
  bankInterest      Decimal @default(0) @db.Decimal(15, 2) // Bank interest not yet recorded
  otherAdjustments  Decimal @default(0) @db.Decimal(15, 2) // Other adjustments

  // Calculated Values
  adjustedBookBalance Decimal @db.Decimal(15, 2) // Book balance after adjustments
  adjustedBankBalance Decimal @db.Decimal(15, 2) // Bank balance after adjustments
  difference          Decimal @default(0) @db.Decimal(15, 2) // Remaining difference
  isBalanced          Boolean @default(false) // True if difference is 0

  // Statement Details
  statementReference String? // Bank statement reference number
  statementFilePath  String? // Uploaded statement file

  // Status
  status BankRecStatus @default(DRAFT)

  // Reconciliation Details
  reconciliationItems BankReconciliationItem[]

  // Approval (RBAC)
  reviewedBy      String?
  reviewedAt      DateTime?
  approvedBy      String?
  approvedAt      DateTime?
  rejectedBy      String?
  rejectedAt      DateTime?
  rejectionReason String?   @db.Text

  // Accounting Integration
  adjustmentJournalId String? // Journal entry for adjustments

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String
  updatedBy String?

  // Notes
  notes   String? @db.Text
  notesId String? @db.Text // Indonesian notes

  @@index([reconciliationNumber])
  @@index([bankAccountId])
  @@index([statementDate])
  @@index([status])
  @@index([isBalanced])
  @@index([periodStartDate, periodEndDate])
  @@index([createdBy])
  @@index([createdAt])
  @@map("bank_reconciliations")
}

// Bank Reconciliation Items (Individual matching items)
model BankReconciliationItem {
  id               String             @id @default(cuid())
  reconciliationId String
  reconciliation   BankReconciliation @relation(fields: [reconciliationId], references: [id], onDelete: Cascade)

  // Item Details
  itemDate      DateTime
  itemType      BankRecItemType // DEPOSIT_IN_TRANSIT, OUTSTANDING_CHECK, BANK_CHARGE, etc.
  description   String
  descriptionId String? // Indonesian description

  // Amounts
  amount Decimal @db.Decimal(15, 2)

  // Matching
  isMatched            Boolean   @default(false)
  matchedTransactionId String? // ID of matched transaction (cash transaction, payment, etc.)
  matchedAt            DateTime?
  matchedBy            String?

  // Status
  status BankRecItemStatus @default(PENDING)

  // Adjustment
  requiresAdjustment  Boolean   @default(false)
  adjustmentJournalId String? // Journal entry if adjustment needed
  adjustedAt          DateTime?

  // Reference
  checkNumber String? // For checks
  reference   String? // External reference

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?

  // Notes
  notes String? @db.Text

  @@index([reconciliationId])
  @@index([itemType])
  @@index([isMatched])
  @@index([status])
  @@index([itemDate])
  @@map("bank_reconciliation_items")
}

// ============================================
// BANK MANAGEMENT ENUMS
// ============================================

enum TransferMethod {
  INTERNAL // Internal transfer (same bank)
  INTERBANK // Inter-bank transfer
  RTGS // Real-Time Gross Settlement
  CLEARING // Bank clearing
  SKN // Sistem Kliring Nasional (Indonesia)
  BIFAST // BI-FAST (Indonesia)
  OTHER // Other methods
}

enum BankTransferStatus {
  PENDING // Created, awaiting approval
  APPROVED // Approved, ready to transfer
  IN_PROGRESS // Transfer in progress
  COMPLETED // Transfer completed
  FAILED // Transfer failed
  REJECTED // Rejected by approver
  CANCELLED // Cancelled by user
}

enum BankRecStatus {
  DRAFT // Being created
  IN_PROGRESS // Reconciliation in progress
  REVIEWED // Reviewed by user
  APPROVED // Approved and balanced
  REJECTED // Rejected, needs rework
  COMPLETED // Fully reconciled and posted
}

enum BankRecItemType {
  DEPOSIT_IN_TRANSIT // Deposit recorded but not on statement
  OUTSTANDING_CHECK // Check issued but not cleared
  BANK_CHARGE // Bank fee/charge
  BANK_INTEREST // Interest earned
  NSF_CHECK // Non-sufficient funds check
  AUTOMATIC_PAYMENT // Automatic payment
  DIRECT_DEPOSIT // Direct deposit
  BANK_ERROR // Bank error
  BOOK_ERROR // Book error
  OTHER_ADJUSTMENT // Other adjustment
}

enum BankRecItemStatus {
  PENDING // Not yet processed
  MATCHED // Matched with transaction
  ADJUSTED // Adjustment made
  CLEARED // Cleared and resolved
  UNRESOLVED // Cannot be resolved
}

// ============================================
// PSAK 16: ASSET DEPRECIATION SYSTEM
// ============================================

// Depreciation Schedule (PSAK 16 Compliant)
model DepreciationSchedule {
  id      String @id @default(cuid())
  assetId String
  asset   Asset  @relation(fields: [assetId], references: [id], onDelete: Cascade)

  // Depreciation Method
  method DepreciationMethod // STRAIGHT_LINE, DECLINING_BALANCE, etc.

  // Asset Values
  depreciableAmount Decimal @db.Decimal(15, 2) // Purchase price - residual value
  residualValue     Decimal @default(0) @db.Decimal(15, 2)

  // Useful Life
  usefulLifeMonths Int // Total useful life in months
  usefulLifeYears  Decimal @db.Decimal(5, 2) // For display purposes

  // Depreciation Rates
  depreciationPerMonth Decimal @db.Decimal(15, 2)
  depreciationPerYear  Decimal @db.Decimal(15, 2)
  annualRate           Decimal @db.Decimal(5, 4) // For declining balance

  // Period
  startDate DateTime // When to start depreciating
  endDate   DateTime // When fully depreciated

  // Status
  isActive    Boolean @default(true)
  isFulfilled Boolean @default(false) // Fully depreciated

  // Notes
  notes   String? @db.Text
  notesId String? @db.Text // Indonesian notes

  // Relations
  depreciationEntries DepreciationEntry[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([assetId])
  @@index([isActive])
  @@index([startDate])
  @@index([endDate])
  @@index([isFulfilled])
  @@map("depreciation_schedules")
}

// Depreciation Entry (Monthly/Periodic)
model DepreciationEntry {
  id String @id @default(cuid())

  // Asset Reference
  assetId String
  asset   Asset  @relation(fields: [assetId], references: [id], onDelete: Cascade)

  // Schedule Reference
  scheduleId String
  schedule   DepreciationSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  // Period
  periodDate     DateTime // Month/period this depreciation is for
  fiscalPeriodId String?
  fiscalPeriod   FiscalPeriod? @relation(fields: [fiscalPeriodId], references: [id])

  // Amounts
  depreciationAmount      Decimal @db.Decimal(15, 2)
  accumulatedDepreciation Decimal @db.Decimal(15, 2) // Total up to this point
  bookValue               Decimal @db.Decimal(15, 2) // Remaining value

  // Accounting Integration
  journalEntryId String?
  journalEntry   JournalEntry? @relation(fields: [journalEntryId], references: [id])

  // Status
  status DepreciationStatus @default(CALCULATED)

  // Audit
  calculatedAt DateTime  @default(now())
  postedAt     DateTime?
  postedBy     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([assetId, periodDate]) // One entry per asset per period
  @@index([assetId])
  @@index([scheduleId])
  @@index([periodDate])
  @@index([fiscalPeriodId])
  @@index([journalEntryId])
  @@index([status])
  @@map("depreciation_entries")
}

// ============================================
// PSAK 71: EXPECTED CREDIT LOSS PROVISION
// ============================================

// Allowance for Doubtful Accounts (PSAK 71 ECL)
model AllowanceForDoubtfulAccounts {
  id String @id @default(cuid())

  // Invoice Reference
  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  // Period
  calculationDate DateTime // When ECL was calculated
  fiscalPeriodId  String?
  fiscalPeriod    FiscalPeriod? @relation(fields: [fiscalPeriodId], references: [id])

  // Aging Classification
  agingBucket String // Current, 1-30, 31-60, 61-90, >90
  daysPastDue Int    @default(0)

  // Amounts
  outstandingAmount Decimal  @db.Decimal(15, 2) // Invoice amount outstanding
  eclRate           Decimal  @db.Decimal(5, 4) // ECL rate based on historical data
  eclAmount         Decimal  @db.Decimal(15, 2) // Calculated ECL provision
  previousEclAmount Decimal? @db.Decimal(15, 2) // Previous provision
  adjustmentAmount  Decimal? @db.Decimal(15, 2) // Incremental adjustment

  // ECL Model
  eclModel       String  @default("12_MONTH") // 12_MONTH or LIFETIME
  lossRateSource String? // Historical, Industry, Other

  // Status
  provisionStatus ECLProvisionStatus @default(ACTIVE)

  // Accounting Integration
  journalEntryId String?
  journalEntry   JournalEntry? @relation(fields: [journalEntryId], references: [id])

  // Write-off Tracking
  writtenOffAt   DateTime?
  writtenOffBy   String?
  writeOffReason String?   @db.Text
  writeOffAmount Decimal?  @db.Decimal(15, 2)

  // Recovery Tracking (if written off invoice is later collected)
  recoveredAt       DateTime?
  recoveredAmount   Decimal?  @db.Decimal(15, 2)
  recoveryJournalId String?

  // Notes
  notes   String? @db.Text
  notesId String? @db.Text // Indonesian notes

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?

  @@index([invoiceId])
  @@index([calculationDate])
  @@index([fiscalPeriodId])
  @@index([agingBucket])
  @@index([provisionStatus])
  @@index([journalEntryId])
  @@index([daysPastDue])
  @@map("allowance_for_doubtful_accounts")
}

// ============================================
// PSAK 16 & 71 ENUMS
// ============================================

enum DepreciationMethod {
  STRAIGHT_LINE // Garis Lurus (most common in Indonesia)
  DECLINING_BALANCE // Saldo Menurun
  DOUBLE_DECLINING // Saldo Menurun Ganda
  SUM_OF_YEARS_DIGITS // Jumlah Angka Tahun
  UNITS_OF_PRODUCTION // Unit Produksi (for equipment)
}

enum DepreciationStatus {
  CALCULATED // Calculated but not posted
  POSTED // Posted to GL
  REVERSED // Reversed entry
  ADJUSTED // Adjustment made
}

enum ECLProvisionStatus {
  ACTIVE // Currently provisioned
  WRITTEN_OFF // Invoice written off as bad debt
  RECOVERED // Written off but later recovered
  REVERSED // Provision reversed (invoice paid)
}

// ============================================
// PSAK 72: REVENUE FROM CONTRACTS
// ============================================

// Deferred Revenue (Pendapatan Diterima Dimuka)
model DeferredRevenue {
  id String @id @default(cuid())

  // Invoice Reference (for advance payments)
  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  // Original Transaction
  paymentDate DateTime // When advance payment received
  totalAmount Decimal  @db.Decimal(15, 2) // Total deferred amount

  // Recognition Schedule
  recognitionDate  DateTime // When revenue should be recognized
  recognizedAmount Decimal  @default(0) @db.Decimal(15, 2) // Amount already recognized
  remainingAmount  Decimal  @db.Decimal(15, 2) // Amount still deferred

  // Status
  status DeferredRevenueStatus @default(DEFERRED)

  // Performance Obligation
  performanceObligation String?  @db.Text // What service/product is owed
  completionPercentage  Decimal? @db.Decimal(5, 2) // % complete

  // Accounting Integration
  initialJournalId     String? // Journal entry when payment received (Cash/Deferred Revenue)
  recognitionJournalId String? // Journal entry when revenue recognized (Deferred Revenue/Revenue)

  // Period
  fiscalPeriodId String?
  fiscalPeriod   FiscalPeriod? @relation(fields: [fiscalPeriodId], references: [id])

  // Notes
  notes   String? @db.Text
  notesId String? @db.Text // Indonesian notes

  // Audit
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  createdBy    String?
  recognizedAt DateTime?
  recognizedBy String?

  @@index([invoiceId])
  @@index([status])
  @@index([recognitionDate])
  @@index([fiscalPeriodId])
  @@index([paymentDate])
  @@map("deferred_revenue")
}

// ============================================
// PAYMENT MILESTONES (Phase 1 Enhancement)
// ============================================
// Payment Milestones for Quotations - structured payment terms for "termin pembayaran"
model PaymentMilestone {
  id String @id @default(cuid())

  // Quotation reference
  quotationId String
  quotation   Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)

  // Milestone details
  milestoneNumber Int // 1, 2, 3... (sequence in quotation)
  name            String // "Down Payment", "Phase 1", "Final Payment"
  nameId          String? // Indonesian: "DP", "Tahap 1", "Pelunasan"
  description     String? @db.Text
  descriptionId   String? @db.Text

  // Payment terms
  paymentPercentage Decimal @db.Decimal(5, 2) // % of total quotation (e.g., 30%)
  paymentAmount     Decimal @db.Decimal(12, 2) // Calculated amount in IDR

  // Timeline
  dueDate         DateTime? // When payment is expected
  dueDaysFromPrev Int? // Alternative: "X days after previous milestone"

  // Deliverables
  deliverables Json? // What client receives at this milestone

  // Status tracking
  isInvoiced Boolean @default(false) // Has invoice been generated?

  // Invoice relation (one-to-many: a payment milestone can have one or more invoices)
  invoices Invoice[] @relation("PaymentMilestoneInvoices")

  // Project milestone link (optional)
  projectMilestoneId String?
  projectMilestone   ProjectMilestone? @relation("PaymentToProjectMilestone", fields: [projectMilestoneId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([quotationId, milestoneNumber])
  @@index([quotationId])
  @@index([projectMilestoneId])
  @@map("payment_milestones")
}

// Project Milestones (for percentage-of-completion revenue recognition)
model ProjectMilestone {
  id String @id @default(cuid())

  // Project Reference
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Milestone Details
  milestoneNumber Int // 1, 2, 3...
  name            String // "Design Phase", "Development", "Testing"
  nameId          String? // Indonesian name
  description     String? @db.Text
  descriptionId   String? @db.Text // Indonesian description

  // Completion
  plannedStartDate     DateTime?
  plannedEndDate       DateTime?
  actualStartDate      DateTime?
  actualEndDate        DateTime?
  completionPercentage Decimal   @default(0) @db.Decimal(5, 2) // 0-100%

  // Revenue Recognition
  plannedRevenue    Decimal @db.Decimal(15, 2) // Revenue allocated to this milestone
  recognizedRevenue Decimal @default(0) @db.Decimal(15, 2) // Revenue already recognized
  remainingRevenue  Decimal @db.Decimal(15, 2) // Revenue not yet recognized

  // Cost Tracking
  estimatedCost Decimal? @db.Decimal(15, 2)
  actualCost    Decimal? @default(0) @db.Decimal(15, 2)

  // Status
  status MilestoneStatus @default(PENDING)

  // Deliverables
  deliverables Json? // Array of deliverables for this milestone
  acceptedBy   String? // Client acceptance
  acceptedAt   DateTime?

  // Accounting Integration
  journalEntryId String? // Revenue recognition journal entry

  // Notes
  notes   String? @db.Text
  notesId String? @db.Text // Indonesian notes

  // ===== PROJECT CALENDAR ENHANCEMENTS =====

  // Priority & Dependencies (for Gantt chart)
  priority      MilestonePriority  @default(MEDIUM)
  predecessorId String? // Dependency on another milestone
  predecessor   ProjectMilestone?  @relation("MilestoneDependency", fields: [predecessorId], references: [id], onDelete: SetNull)
  successors    ProjectMilestone[] @relation("MilestoneDependency")

  // Delay Tracking
  delayDays   Int?    @default(0) // Days delayed from planned
  delayReason String? @db.Text // Reason for delay

  // Phase 1 Enhancement: Payment Milestone Integration
  paymentMilestones PaymentMilestone[] @relation("PaymentToProjectMilestone") // Link to quotation payment terms
  invoices          Invoice[]          @relation("ProjectMilestoneInvoices") // Invoices generated from this milestone

  // Phase 1 Enhancement: Indonesian Business Fields
  materaiRequired Boolean @default(false) // Does this milestone invoice need stamp duty?
  taxTreatment    String? // "PPN 11%", "PPh 23", etc.

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?

  @@unique([projectId, milestoneNumber]) // Unique milestone numbers per project
  @@index([projectId])
  @@index([status])
  @@index([completionPercentage])
  @@index([milestoneNumber])
  @@index([projectId, plannedStartDate]) // Calendar queries
  @@index([status, plannedEndDate]) // Deadline tracking
  @@index([priority]) // Priority filtering
  @@index([predecessorId]) // Dependency tracking
  @@map("project_milestones")
}

// ============================================
// PSAK 72 ENUMS
// ============================================

enum DeferredRevenueStatus {
  DEFERRED // Revenue deferred, not yet earned
  PARTIALLY_RECOGNIZED // Some revenue recognized
  FULLY_RECOGNIZED // All revenue recognized
  REFUNDED // Payment refunded (service cancelled)
}

enum MilestoneStatus {
  PENDING // Not started
  IN_PROGRESS // Work in progress
  COMPLETED // Completed, awaiting client acceptance
  ACCEPTED // Client accepted
  BILLED // Invoice created for this milestone
  CANCELLED // Milestone cancelled
}

enum MilestonePriority {
  LOW // Low priority milestone
  MEDIUM // Medium priority (default)
  HIGH // High priority / Critical path
}

// ============================================
// PSAK 57: PROJECT CONTRACTS & COSTING
// ============================================

// Work in Progress (Pekerjaan Dalam Proses)
model WorkInProgress {
  id String @id @default(cuid())

  // Project Reference
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Period
  periodDate     DateTime // Month/period for this WIP calculation
  fiscalPeriodId String?
  fiscalPeriod   FiscalPeriod? @relation(fields: [fiscalPeriodId], references: [id])

  // Cost Accumulation
  directMaterialCost Decimal @default(0) @db.Decimal(15, 2) // Direct material costs
  directLaborCost    Decimal @default(0) @db.Decimal(15, 2) // Direct labor costs
  directExpenses     Decimal @default(0) @db.Decimal(15, 2) // Direct expenses
  allocatedOverhead  Decimal @default(0) @db.Decimal(15, 2) // Allocated overhead
  totalCost          Decimal @default(0) @db.Decimal(15, 2) // Total accumulated cost

  // Revenue Recognition
  billedToDate      Decimal @default(0) @db.Decimal(15, 2) // Amount billed to customer
  recognizedRevenue Decimal @default(0) @db.Decimal(15, 2) // Revenue recognized
  unbilledRevenue   Decimal @default(0) @db.Decimal(15, 2) // Earned but not billed

  // Project Status
  completionPercentage Decimal @default(0) @db.Decimal(5, 2) // 0-100%
  isCompleted          Boolean @default(false)

  // Accounting Integration
  costJournalId    String? // Journal entry for cost accumulation
  revenueJournalId String? // Journal entry for revenue recognition

  // Notes
  notes   String? @db.Text
  notesId String? @db.Text // Indonesian notes

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?

  @@unique([projectId, periodDate]) // One WIP entry per project per period
  @@index([projectId])
  @@index([periodDate])
  @@index([fiscalPeriodId])
  @@index([isCompleted])
  @@map("work_in_progress")
}

// Project Cost Allocation (for overhead distribution)
model ProjectCostAllocation {
  id String @id @default(cuid())

  // Project Reference
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Expense Reference
  expenseId String
  expense   Expense @relation(fields: [expenseId], references: [id], onDelete: Cascade)

  // Allocation Details
  allocationDate       DateTime         @default(now())
  allocationMethod     AllocationMethod // PERCENTAGE, HOURS, DIRECT
  allocationPercentage Decimal?         @db.Decimal(5, 2) // For percentage-based allocation
  allocatedAmount      Decimal          @db.Decimal(15, 2) // Amount allocated to this project

  // Accounting Integration
  journalEntryId String? // Journal entry for cost allocation

  // Cost Classification
  costType CostType // MATERIAL, LABOR, OVERHEAD
  isDirect Boolean  @default(true) // Direct vs Indirect cost

  // Notes
  notes   String? @db.Text
  notesId String? @db.Text

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?

  // Labor Entry Relation
  laborEntries LaborEntry[] @relation("CostAllocationLabor")

  @@index([projectId])
  @@index([expenseId])
  @@index([allocationDate])
  @@index([costType])
  @@map("project_cost_allocations")
}

// ============================================
// PSAK 57 ENUMS
// ============================================

enum AllocationMethod {
  PERCENTAGE // Allocate by percentage
  HOURS // Allocate by hours worked
  DIRECT // Direct cost assignment
  SQUARE_METER // Allocate by area (for facilities)
  HEADCOUNT // Allocate by number of people
}

enum CostType {
  MATERIAL // Direct material costs
  LABOR // Direct labor costs
  OVERHEAD // Overhead/indirect costs
  SUBCONTRACTOR // Subcontractor costs
  EQUIPMENT // Equipment/asset usage costs
}

// ============================================
// PURCHASE-TO-PAY SYSTEM
// ============================================
// This section adds comprehensive vendor management and purchase-to-pay functionality
// Integrated with existing Expense, Asset, and Project modules for Indonesian compliance

// ==========================================================
// VENDOR MASTER DATA
// ==========================================================

model Vendor {
  id         String  @id @default(cuid())
  vendorCode String  @unique // VEN-2025-0001
  name       String
  nameId     String? // Indonesian name

  // Vendor Classification
  vendorType   VendorType
  industryType String?

  // Contact Information
  contactPerson String?
  email         String?
  phone         String?
  address       String?
  city          String?
  province      String?
  postalCode    String?
  country       String  @default("Indonesia")

  // Tax Information (Indonesian Compliance)
  npwp       String?   @unique // Nomor Pokok Wajib Pajak (Tax ID)
  pkpStatus  PKPStatus @default(NON_PKP)
  taxAddress String? // Tax invoice address

  // Banking Information
  bankName          String?
  bankAccountNumber String?
  bankAccountName   String?
  bankBranch        String?
  swiftCode         String?

  // Payment Terms
  paymentTerms String   @default("NET 30") // NET 30, NET 60, COD, etc.
  creditLimit  Decimal? @db.Decimal(15, 2)
  currency     String   @default("IDR")

  // Status
  isActive Boolean @default(true)
  isPKP    Boolean @default(false) // Pengusaha Kena Pajak (VAT registered)

  // Audit Fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String
  updatedBy String?

  // Relations
  purchaseOrders  PurchaseOrder[]
  goodsReceipts   GoodsReceipt[]
  vendorInvoices  VendorInvoice[]
  accountsPayable AccountsPayable[]
  vendorPayments  VendorPayment[]
  expenses        Expense[] // Link existing expenses to vendor
  assets          Asset[] // Link assets purchased from vendor

  @@index([vendorCode])
  @@index([npwp])
  @@index([isActive])
  @@index([vendorType])
  @@index([name])
  @@map("vendors")
}

// ==========================================================
// PURCHASE ORDER SYSTEM
// ==========================================================

model PurchaseOrder {
  id       String   @id @default(cuid())
  poNumber String   @unique // PO-2025-01-0001
  poDate   DateTime @default(now())

  // Vendor
  vendorId String
  vendor   Vendor @relation(fields: [vendorId], references: [id])

  // Project (Optional)
  projectId String?
  project   Project? @relation(fields: [projectId], references: [id])

  // Line Items
  items PurchaseOrderItem[]

  // Financial Summary
  subtotal       Decimal @db.Decimal(15, 2)
  discountAmount Decimal @default(0) @db.Decimal(15, 2)
  ppnAmount      Decimal @db.Decimal(15, 2)
  pphAmount      Decimal @default(0) @db.Decimal(15, 2)
  totalAmount    Decimal @db.Decimal(15, 2)

  // Indonesian Tax
  isPPNIncluded      Boolean            @default(true)
  ppnRate            Decimal            @default(12) @db.Decimal(5, 2) // 12%
  withholdingTaxType WithholdingTaxType @default(NONE)
  withholdingTaxRate Decimal?           @db.Decimal(5, 2)

  // Delivery & Payment
  deliveryAddress String?
  deliveryDate    DateTime?
  paymentTerms    String    @default("NET 30")
  dueDate         DateTime?

  // Status & Workflow
  status         POStatus       @default(DRAFT)
  approvalStatus ApprovalStatus @default(PENDING)

  // Approval Trail
  requestedBy     String
  approvedBy      String?
  approvedAt      DateTime?
  rejectedBy      String?
  rejectedAt      DateTime?
  rejectionReason String?

  // Fulfillment Tracking
  totalReceived Decimal   @default(0) @db.Decimal(15, 2)
  totalInvoiced Decimal   @default(0) @db.Decimal(15, 2)
  isClosed      Boolean   @default(false)
  closedAt      DateTime?
  closedBy      String?
  closureReason String?

  // Notes
  description     String?
  descriptionId   String? // Indonesian description
  notes           String?
  termsConditions String?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String
  updatedBy String?

  // Relations
  goodsReceipts  GoodsReceipt[]
  vendorInvoices VendorInvoice[]
  expenses       Expense[]
  assets         Asset[]
  journalEntryId String? // PO commitment entry

  @@index([poNumber])
  @@index([vendorId])
  @@index([projectId])
  @@index([status])
  @@index([poDate])
  @@index([approvalStatus])
  @@index([requestedBy])
  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id   String        @id @default(cuid())
  poId String
  po   PurchaseOrder @relation(fields: [poId], references: [id], onDelete: Cascade)

  lineNumber Int // 1, 2, 3...

  // Item Details
  itemType      POItemType
  itemCode      String? // SKU or service code
  description   String
  descriptionId String? // Indonesian description

  // Quantity & Pricing
  quantity        Decimal @db.Decimal(15, 3)
  unit            String // pcs, kg, hour, m2, etc.
  unitPrice       Decimal @db.Decimal(15, 2)
  discountPercent Decimal @default(0) @db.Decimal(5, 2)
  discountAmount  Decimal @default(0) @db.Decimal(15, 2)
  lineTotal       Decimal @db.Decimal(15, 2)

  // PPN per line item
  ppnAmount Decimal @db.Decimal(15, 2)

  // Fulfillment Tracking
  quantityReceived    Decimal @default(0) @db.Decimal(15, 3)
  quantityInvoiced    Decimal @default(0) @db.Decimal(15, 3)
  quantityOutstanding Decimal @db.Decimal(15, 3)

  // Asset/Project Linking
  assetId           String?
  asset             Asset?           @relation(fields: [assetId], references: [id])
  expenseCategoryId String?
  expenseCategory   ExpenseCategory? @relation(fields: [expenseCategoryId], references: [id])

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  goodsReceiptItems  GoodsReceiptItem[]
  vendorInvoiceItems VendorInvoiceItem[]

  @@index([poId])
  @@index([assetId])
  @@index([expenseCategoryId])
  @@map("purchase_order_items")
}

// ==========================================================
// GOODS RECEIPT SYSTEM
// ==========================================================

model GoodsReceipt {
  id       String   @id @default(cuid())
  grNumber String   @unique // GR-2025-01-0001
  grDate   DateTime @default(now())

  // Reference
  poId     String
  po       PurchaseOrder @relation(fields: [poId], references: [id])
  vendorId String
  vendor   Vendor        @relation(fields: [vendorId], references: [id])

  // Delivery Details
  deliveryNoteNumber String? // Vendor's delivery note
  receivedBy         String
  receivedAt         DateTime @default(now())
  warehouseLocation  String?

  // Quality Check
  inspectionStatus InspectionStatus @default(PENDING)
  inspectedBy      String?
  inspectedAt      DateTime?
  inspectionNotes  String?

  // Line Items
  items GoodsReceiptItem[]

  // Status
  status   GRStatus  @default(DRAFT)
  isPosted Boolean   @default(false)
  postedAt DateTime?

  // Notes
  notes   String?
  notesId String?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String
  updatedBy String?

  // Relations
  vendorInvoices VendorInvoice[]
  journalEntryId String? // GR accrual entry
  assets         Asset[]

  @@index([grNumber])
  @@index([poId])
  @@index([vendorId])
  @@index([grDate])
  @@index([status])
  @@map("goods_receipts")
}

model GoodsReceiptItem {
  id   String       @id @default(cuid())
  grId String
  gr   GoodsReceipt @relation(fields: [grId], references: [id], onDelete: Cascade)

  poItemId String
  poItem   PurchaseOrderItem @relation(fields: [poItemId], references: [id])

  lineNumber Int

  // Quantity Details
  orderedQuantity  Decimal @db.Decimal(15, 3)
  receivedQuantity Decimal @db.Decimal(15, 3)
  acceptedQuantity Decimal @db.Decimal(15, 3)
  rejectedQuantity Decimal @default(0) @db.Decimal(15, 3)

  // Quality
  qualityStatus   QualityStatus @default(PENDING)
  rejectionReason String?

  // Pricing (from PO)
  unitPrice Decimal @db.Decimal(15, 2)
  lineTotal Decimal @db.Decimal(15, 2)

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([grId])
  @@index([poItemId])
  @@map("goods_receipt_items")
}

// ==========================================================
// VENDOR INVOICE SYSTEM (Three-Way Matching)
// ==========================================================

model VendorInvoice {
  id String @id @default(cuid())

  // Numbers
  vendorInvoiceNumber String // Vendor's invoice number
  internalNumber      String   @unique // VI-2025-01-0001
  invoiceDate         DateTime

  // Vendor
  vendorId String
  vendor   Vendor @relation(fields: [vendorId], references: [id])

  // References for Three-Way Matching
  poId String?
  po   PurchaseOrder? @relation(fields: [poId], references: [id])
  grId String?
  gr   GoodsReceipt?  @relation(fields: [grId], references: [id])

  // Line Items
  items VendorInvoiceItem[]

  // Financial
  subtotal       Decimal @db.Decimal(15, 2)
  discountAmount Decimal @default(0) @db.Decimal(15, 2)
  ppnAmount      Decimal @db.Decimal(15, 2)
  pphAmount      Decimal @default(0) @db.Decimal(15, 2)
  totalAmount    Decimal @db.Decimal(15, 2)

  // Indonesian E-Faktur
  eFakturNSFP       String?       @unique // Nomor Seri Faktur Pajak
  eFakturQRCode     String?
  eFakturStatus     EFakturStatus @default(NOT_REQUIRED)
  eFakturUploadDate DateTime?

  // Payment Terms
  paymentTerms String
  dueDate      DateTime

  // Three-Way Matching
  matchingStatus MatchingStatus @default(UNMATCHED)
  matchedBy      String?
  matchedAt      DateTime?
  matchingNotes  String?

  // Tolerance Check Results
  priceVariance    Decimal? @db.Decimal(15, 2)
  quantityVariance Decimal? @db.Decimal(15, 3)
  withinTolerance  Boolean  @default(false)

  // Status
  status         VIStatus       @default(DRAFT)
  approvalStatus ApprovalStatus @default(PENDING)

  // Approval
  approvedBy      String?
  approvedAt      DateTime?
  rejectedBy      String?
  rejectedAt      DateTime?
  rejectionReason String?

  // Accounting
  accountsPayableId String?          @unique
  accountsPayable   AccountsPayable? @relation(fields: [accountsPayableId], references: [id])
  journalEntryId    String?

  // Notes
  description   String?
  descriptionId String?
  notes         String?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String
  updatedBy String?

  // Relations
  expenses Expense[]
  Asset    Asset[]

  @@index([vendorId])
  @@index([poId])
  @@index([grId])
  @@index([internalNumber])
  @@index([eFakturNSFP])
  @@index([status])
  @@index([matchingStatus])
  @@index([invoiceDate])
  @@index([dueDate])
  @@map("vendor_invoices")
}

model VendorInvoiceItem {
  id   String        @id @default(cuid())
  viId String
  vi   VendorInvoice @relation(fields: [viId], references: [id], onDelete: Cascade)

  poItemId String?
  poItem   PurchaseOrderItem? @relation(fields: [poItemId], references: [id])

  lineNumber Int

  // Item Details
  description   String
  descriptionId String?

  // Quantity & Pricing
  quantity       Decimal @db.Decimal(15, 3)
  unit           String
  unitPrice      Decimal @db.Decimal(15, 2)
  discountAmount Decimal @default(0) @db.Decimal(15, 2)
  lineTotal      Decimal @db.Decimal(15, 2)
  ppnAmount      Decimal @db.Decimal(15, 2)

  // Matching Flags
  isMatched      Boolean @default(false)
  varianceReason String?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([viId])
  @@index([poItemId])
  @@map("vendor_invoice_items")
}

// ==========================================================
// ACCOUNTS PAYABLE SYSTEM
// ==========================================================

model AccountsPayable {
  id       String @id @default(cuid())
  apNumber String @unique // AP-2025-01-0001

  // Vendor
  vendorId String
  vendor   Vendor @relation(fields: [vendorId], references: [id])

  // Source Document
  sourceType      APSourceType
  vendorInvoiceId String?        @unique
  vendorInvoice   VendorInvoice?
  expenseId       String?        @unique
  expense         Expense?       @relation(fields: [expenseId], references: [id])

  // Financial
  originalAmount    Decimal @db.Decimal(15, 2)
  paidAmount        Decimal @default(0) @db.Decimal(15, 2)
  outstandingAmount Decimal @db.Decimal(15, 2)

  // Dates
  invoiceDate DateTime
  dueDate     DateTime

  // Status
  paymentStatus APPaymentStatus @default(UNPAID)

  // Aging
  daysOutstanding Int? // Calculated
  agingBucket     String? // Current, 1-30, 31-60, etc.

  // Accounting
  journalEntryId String?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String
  updatedBy String?

  // Relations
  paymentAllocations VendorPaymentAllocation[]

  @@index([vendorId])
  @@index([paymentStatus])
  @@index([dueDate])
  @@index([agingBucket])
  @@index([apNumber])
  @@index([invoiceDate])
  @@map("accounts_payable")
}

// ==========================================================
// VENDOR PAYMENT SYSTEM
// ==========================================================

model VendorPayment {
  id            String   @id @default(cuid())
  paymentNumber String   @unique // VP-2025-01-0001
  paymentDate   DateTime @default(now())

  // Vendor
  vendorId String
  vendor   Vendor @relation(fields: [vendorId], references: [id])

  // Payment Details
  paymentMethod   PaymentMethod
  referenceNumber String? // Check number, transfer ref, etc.
  bankAccountId   String? // Paying bank account

  // Amount
  totalAmount Decimal @db.Decimal(15, 2)

  // Allocation
  allocations VendorPaymentAllocation[]

  // Status
  status    VendorPaymentStatus @default(DRAFT)
  clearedAt DateTime? // When bank cleared

  // Accounting
  journalEntryId String?

  // Notes
  notes   String?
  notesId String?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String
  updatedBy String?

  @@index([vendorId])
  @@index([paymentDate])
  @@index([status])
  @@index([paymentNumber])
  @@map("vendor_payments")
}

model VendorPaymentAllocation {
  id String @id @default(cuid())

  paymentId String
  payment   VendorPayment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  apId String
  ap   AccountsPayable @relation(fields: [apId], references: [id])

  allocatedAmount Decimal @db.Decimal(15, 2)

  createdAt DateTime @default(now())

  @@index([paymentId])
  @@index([apId])
  @@map("vendor_payment_allocations")
}

// ==========================================================
// PURCHASE-TO-PAY ENUMS
// ==========================================================

enum VendorType {
  SUPPLIER // Material/goods supplier
  SERVICE_PROVIDER // Service vendor
  CONTRACTOR // Construction contractor
  CONSULTANT // Professional services
  UTILITY // Utilities (electric, water)
  GOVERNMENT // Government agencies
  OTHER
}

enum PKPStatus {
  PKP // Pengusaha Kena Pajak (VAT registered)
  NON_PKP // Not VAT registered
  GOVERNMENT // Government entity
}

enum POStatus {
  DRAFT // Being created
  PENDING // Awaiting approval
  APPROVED // Approved, ready to send
  SENT // Sent to vendor
  PARTIAL // Partially received
  COMPLETED // Fully received
  CANCELLED // Cancelled
  CLOSED // Manually closed
}

enum POItemType {
  GOODS // Physical goods
  SERVICE // Services
  ASSET // Capital asset purchase
  EXPENSE // Operating expense
}

enum ApprovalStatus {
  PENDING // Awaiting approval
  APPROVED // Approved
  REJECTED // Rejected
}

enum GRStatus {
  DRAFT
  RECEIVED
  INSPECTED
  POSTED
  CANCELLED
}

enum InspectionStatus {
  PENDING
  IN_PROGRESS
  PASSED
  FAILED
  PARTIAL
}

enum QualityStatus {
  PENDING
  ACCEPTED
  REJECTED
  CONDITIONAL
}

enum VIStatus {
  DRAFT
  PENDING_MATCH
  MATCHED
  APPROVED
  POSTED
  PAID
  CANCELLED
}

enum MatchingStatus {
  UNMATCHED // Not yet matched
  MATCHED // All items matched within tolerance
  PARTIAL_MATCH // Some items matched
  VARIANCE // Matched but has variances
  FAILED // Matching failed
}

enum APSourceType {
  VENDOR_INVOICE
  EXPENSE
  MANUAL_ENTRY
}

enum APPaymentStatus {
  UNPAID
  PARTIALLY_PAID
  PAID
  OVERDUE
  WRITTEN_OFF
}

enum VendorPaymentStatus {
  DRAFT
  PENDING
  POSTED
  CLEARED
  CANCELLED
  REVERSED
}

// ==========================================================
// PURCHASE SOURCE ENUMS (for Expense model)
// ==========================================================

enum PurchaseType {
  DIRECT // Paid immediately
  CREDIT // Buy now, pay later
  FROM_PO // Sourced from purchase order
}

enum PurchaseSource {
  MANUAL // User creates expense directly
  FROM_PO // Generated from PO
  FROM_VENDOR_INVOICE // Generated from vendor invoice
}

// ==========================================================
// TEAM & RESOURCES MANAGEMENT
// ==========================================================

model ProjectTeamMember {
  id String @id @default(cuid())

  // Project Reference
  projectId String
  project   Project @relation("ProjectTeam", fields: [projectId], references: [id], onDelete: Cascade)

  // User Reference
  userId String
  user   User   @relation("UserProjectAssignments", fields: [userId], references: [id], onDelete: Cascade)

  // Assignment Details
  role               String // "Lead Designer", "Developer", "Project Manager"
  roleId             String? // Indonesian role name
  allocationPercent  Decimal @default(100) @db.Decimal(5, 2) // % of time on this project
  hourlyRate         Decimal @db.Decimal(12, 2) // Hourly rate for this assignment
  hourlyRateCurrency String  @default("IDR")

  // Assignment Period
  assignedDate DateTime  @default(now())
  startDate    DateTime // When assignment starts
  endDate      DateTime? // When assignment ends (null = ongoing)

  // Status
  isActive Boolean @default(true)

  // Notes
  notes   String? @db.Text
  notesId String? @db.Text // Indonesian notes

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  // Relations
  laborEntries LaborEntry[]

  @@unique([projectId, userId, assignedDate]) // Unique assignment per project/user/date
  @@index([projectId])
  @@index([userId])
  @@index([isActive])
  @@index([startDate])
  @@index([endDate])
  @@map("project_team_members")
}

model LaborEntry {
  id String @id @default(cuid())

  // Project & Team Member Reference
  projectId    String
  project      Project           @relation("ProjectLabor", fields: [projectId], references: [id], onDelete: Cascade)
  teamMemberId String
  teamMember   ProjectTeamMember @relation(fields: [teamMemberId], references: [id], onDelete: Cascade)
  userId       String
  user         User              @relation("UserLaborEntries", fields: [userId], references: [id], onDelete: Restrict)

  // Labor Details
  workDate      DateTime  @db.Date // Date of work
  hoursWorked   Decimal   @db.Decimal(5, 2) // Hours worked (e.g., 8.5)
  laborType     LaborType @default(REGULAR) // REGULAR, OVERTIME, HOLIDAY
  laborTypeRate Decimal   @db.Decimal(3, 2) // Multiplier (1.0, 1.5, 2.0)

  // Cost Calculation
  hourlyRate Decimal @db.Decimal(12, 2) // Rate at time of entry
  laborCost  Decimal @db.Decimal(15, 2) // hours  rate  typeRate

  // Indonesian Compliance
  costType CostType @default(LABOR) // For PSAK 57 integration
  isDirect Boolean  @default(true) // Direct labor cost

  // Description
  description   String? @db.Text
  descriptionId String? @db.Text // Indonesian description
  taskPerformed String? @db.Text // What task was worked on

  // Approval Status
  status         LaborEntryStatus @default(DRAFT)
  submittedAt    DateTime?
  approvedBy     String? // User ID
  approvedAt     DateTime?
  rejectedReason String?          @db.Text

  //  EXPENSE SYSTEM INTEGRATION
  expenseId String? // Link to created Expense record (set on approval)
  expense   Expense? @relation("ExpenseLaborEntries", fields: [expenseId], references: [id])

  // Accounting Integration
  journalEntryId   String? // Link to journal entry when approved
  costAllocationId String? // Link to ProjectCostAllocation (created with Expense)
  costAllocation   ProjectCostAllocation? @relation("CostAllocationLabor", fields: [costAllocationId], references: [id])

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  @@unique([teamMemberId, workDate]) // One entry per day per team member
  @@index([projectId])
  @@index([userId])
  @@index([workDate])
  @@index([status])
  @@index([teamMemberId])
  @@index([expenseId]) //  NEW: Index for expense lookup
  @@map("labor_entries")
}

// ==========================================================
// TEAM & RESOURCES ENUMS
// ==========================================================

enum LaborType {
  REGULAR // Normal working hours (1.0x rate)
  OVERTIME // Overtime hours (1.5x rate)
  HOLIDAY // Holiday hours (2.0x rate)
  WEEKEND // Weekend hours (1.5x rate)
}

enum LaborEntryStatus {
  DRAFT // Created but not submitted
  SUBMITTED // Submitted for approval
  APPROVED // Approved by manager (creates Expense)
  REJECTED // Rejected by manager
  BILLED // Included in invoice (via Expense)
}

// ==========================================================
// INDONESIAN HOLIDAY CALENDAR
// ==========================================================

model IndonesianHoliday {
  id String @id @default(cuid())

  // Date Information
  date DateTime @db.Date // Holiday date
  year Int // Year for indexing

  // Holiday Details
  name           String // English name: "Independence Day"
  nameIndonesian String // Indonesian name: "Hari Kemerdekaan RI"
  description    String? @db.Text

  // Classification
  type   HolidayType @default(NATIONAL)
  region String? // null = National, or "Jakarta", "Surabaya", etc.

  // Special Characteristics
  isLunarBased Boolean @default(false) // For Islamic/Chinese holidays
  isSubstitute Boolean @default(false) // Cuti bersama or substitute holiday

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([date, region]) // One holiday per date per region
  @@index([date])
  @@index([year])
  @@index([type])
  @@index([region])
  @@map("indonesian_holidays")
}

// ============================================
// ATOMIC COUNTERS (Phase 1 Enhancement)
// ============================================
// Thread-safe counters for invoice and quotation number generation

model InvoiceCounter {
  id        String   @id @default(cuid())
  year      Int
  month     Int
  sequence  Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([year, month])
  @@index([year, month])
  @@map("invoice_counters")
}

model QuotationCounter {
  id        String   @id @default(cuid())
  year      Int
  month     Int
  sequence  Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([year, month])
  @@index([year, month])
  @@map("quotation_counters")
}

enum HolidayType {
  NATIONAL // National holidays (e.g., Independence Day)
  RELIGIOUS // Religious holidays (e.g., Eid al-Fitr, Christmas)
  REGIONAL // Regional holidays (e.g., Nyepi in Bali)
  SUBSTITUTE // Cuti bersama / substitute holiday
}

// ==========================================
// ADDITIONAL MODELS (from recent migrations)
// ==========================================

model CashBankBalance {
  id              String    @id @default(cuid())
  period          String    @db.VarChar(100)
  periodDate      DateTime
  year            Int
  month           Int
  openingBalance  Decimal   @db.Decimal(15, 2)
  closingBalance  Decimal   @db.Decimal(15, 2)
  totalInflow     Decimal   @db.Decimal(15, 2)
  totalOutflow    Decimal   @db.Decimal(15, 2)
  netChange       Decimal   @db.Decimal(15, 2)
  calculatedAt    DateTime?
  calculatedBy    String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  createdBy       String?
  updatedBy       String?
  notes           String?

  @@unique([year, month])
  @@index([periodDate])
  @@index([year, month])
  @@index([createdAt])
  @@map("cash_bank_balances")
}

model SocialMediaReport {
  id              String          @id @default(cuid())
  projectId       String
  title           String
  description     String?
  month           Int
  year            Int
  status          ReportStatus    @default(DRAFT)
  pdfUrl          String?
  pdfGeneratedAt  DateTime?
  pdfVersion      Int             @default(1)
  emailedAt       DateTime?
  emailedTo       String[]
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  createdBy       String?
  updatedBy       String?
  project         Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  sections        ReportSection[]

  @@unique([projectId, year, month])
  @@index([projectId])
  @@index([status])
  @@index([year, month])
  @@map("social_media_reports")
}

model ReportSection {
  id              String            @id @default(cuid())
  reportId        String
  order           Int
  title           String
  description     String?
  csvFileName     String
  csvFilePath     String?
  importedAt      DateTime          @default(now())
  columnTypes     Json
  rawData         Json
  rowCount        Int
  visualizations  Json
  layout          Json?
  layoutVersion   Int               @default(1)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  report          SocialMediaReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([reportId, order])
  @@map("report_sections")
}

enum ReportStatus {
  DRAFT
  COMPLETED
  SENT
}

model ContentCalendarItem {
  id          String            @id @default(cuid())
  caption     String            @db.Text // Social media caption (replaces title & description)
  scheduledAt DateTime?
  publishedAt DateTime?
  status      ContentStatus     @default(DRAFT)
  platforms   ContentPlatform[]
  clientId    String?
  projectId   String?
  createdBy   String
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  client      Client?           @relation(fields: [clientId], references: [id], onDelete: Cascade)
  project     Project?          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdByUser User            @relation(fields: [createdBy], references: [id])
  media       ContentMedia[]

  @@index([status])
  @@index([scheduledAt])
  @@index([clientId])
  @@index([projectId])
  @@index([createdBy])
  @@index([status, scheduledAt])
  @@map("content_calendar_items")
}

model ContentMedia {
  id            String              @id @default(cuid())
  url           String
  key           String
  type          MediaType
  mimeType      String
  size          Int
  width         Int?
  height        Int?
  duration      Int?
  thumbnailUrl  String?             // Thumbnail URL for video previews
  thumbnailKey  String?             // Thumbnail R2 key for deletion
  originalName  String?
  order         Int                 @default(0) // Carousel order (0 = first, 1 = second, etc.)
  contentId     String
  uploadedAt    DateTime            @default(now())
  content       ContentCalendarItem @relation(fields: [contentId], references: [id], onDelete: Cascade)

  @@index([contentId])
  @@index([type])
  @@index([uploadedAt])
  @@index([contentId, order]) // Composite index for efficient ordering
  @@map("content_media")
}

enum ContentStatus {
  DRAFT
  SCHEDULED
  PUBLISHED
  FAILED
  ARCHIVED
}

enum MediaType {
  IMAGE
  VIDEO
  CAROUSEL
}

enum ContentPlatform {
  INSTAGRAM
  TIKTOK
  FACEBOOK
  TWITTER
  LINKEDIN
  YOUTUBE
}

// ============================================
// MEDIA COLLABORATION MODELS
// ============================================

// Media projects group related assets (videos + photos)
model MediaProject {
  id              String            @id @default(cuid())
  name            String
  description     String?           @db.Text

  // Link to business entities
  clientId        String?
  client          Client?           @relation(fields: [clientId], references: [id], onDelete: SetNull)
  projectId       String?
  project         Project?          @relation(fields: [projectId], references: [id], onDelete: SetNull)

  // Organization (for organizing projects themselves)
  folderId        String?
  parentFolder    MediaFolder?      @relation("MediaProjectParentFolder", fields: [folderId], references: [id], onDelete: SetNull)

  // Ownership
  createdBy       String
  creator         User              @relation("MediaProjectCreator", fields: [createdBy], references: [id])

  // PUBLIC SHARING FIELDS
  isPublic           Boolean            @default(false)  // Enable/disable public access
  publicShareToken   String?            @unique          // Unique token for public link
  publicShareUrl     String?                             // Full URL for sharing
  publicViewCount    Int                @default(0)      // Track how many times viewed
  publicSharedAt     DateTime?                           // When sharing was enabled
  publicAccessLevel  PublicAccessLevel  @default(VIEW_ONLY)  // Future: allow downloads, comments

  // Relations
  assets          MediaAsset[]
  collaborators   MediaCollaborator[]
  collections     Collection[]
  folders         MediaFolder[]     @relation("MediaProjectFolders")
  decks           Deck[]

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([clientId])
  @@index([projectId])
  @@index([folderId])
  @@index([createdBy])
  @@index([publicShareToken])
  @@map("media_projects")
}

// Folder structure for organizing assets within a project
model MediaFolder {
  id              String            @id @default(cuid())
  name            String
  description     String?           @db.Text
  projectId       String
  project         MediaProject      @relation("MediaProjectFolders", fields: [projectId], references: [id], onDelete: Cascade)

  parentId        String?
  parent          MediaFolder?      @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children        MediaFolder[]     @relation("FolderHierarchy")

  assets          MediaAsset[]      @relation("MediaAssetFolder")
  projectsInFolder MediaProject[]   @relation("MediaProjectParentFolder")

  createdById     String
  createdBy       User              @relation("MediaFolderCreator", fields: [createdById], references: [id])

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([projectId])
  @@index([parentId])
  @@index([createdById])
  @@map("media_folders")
}

// Individual media assets (videos + photos unified)
model MediaAsset {
  id              String            @id @default(cuid())
  projectId       String
  project         MediaProject      @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Folder organization
  folderId        String?
  folder          MediaFolder?      @relation("MediaAssetFolder", fields: [folderId], references: [id], onDelete: SetNull)

  // File metadata
  filename        String
  originalName    String
  description     String?           @db.Text

  // Storage
  url             String            // R2 public URL
  key             String            // R2 storage key
  thumbnailUrl    String?           // Generated thumbnail

  // Media type and properties
  mediaType       MediaAssetType    // VIDEO, IMAGE, RAW_IMAGE
  mimeType        String            // video/mp4, image/jpeg, image/x-canon-cr2, etc.
  size            BigInt            // File size in bytes

  // Video-specific properties
  duration        Decimal?          @db.Decimal(10, 3)  // Duration in seconds (video only)
  fps             Decimal?          @db.Decimal(6, 2)   // Frames per second (video only)
  codec           String?           // h264, vp9, etc. (video only)
  bitrate         Int?              // Bitrate in kbps (video only)

  // Image/Video dimensions
  width           Int?              // Width in pixels
  height          Int?              // Height in pixels

  // Review status and rating
  status          MediaReviewStatus @default(DRAFT)
  starRating      Int?              // 1-5 stars (nullable, 0 = no rating)

  // Ownership
  uploadedBy      String
  uploader        User              @relation("MediaAssetUploader", fields: [uploadedBy], references: [id])

  // Relations
  versions        MediaVersion[]
  frames          MediaFrame[]      // For video frames OR photo annotations
  metadata        AssetMetadata?    // Extended metadata
  collectionItems CollectionItem[]  // Membership in collections

  uploadedAt      DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([projectId])
  @@index([folderId])
  @@index([uploadedBy])
  @@index([status])
  @@index([starRating])
  @@index([mediaType])
  @@index([projectId, starRating])
  @@map("media_assets")
}

// Extended metadata for assets
model AssetMetadata {
  id              String            @id @default(cuid())
  assetId         String            @unique
  asset           MediaAsset        @relation(fields: [assetId], references: [id], onDelete: Cascade)

  // Assignment and workflow
  assigneeId      String?
  assignee        User?             @relation("AssetAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)
  dueDate         DateTime?

  // Social media context (reusing ContentPlatform enum)
  platforms       ContentPlatform[]

  // Tags and custom fields
  tags            String[]          // Hashtags for organization
  customFields    Json?             // User-defined metadata

  // EXIF data (for photos)
  cameraModel     String?
  cameraMake      String?
  lens            String?
  iso             Int?
  aperture        Decimal?          @db.Decimal(4, 2)  // f/2.8
  shutterSpeed    String?           // "1/1000"
  focalLength     Int?              // mm
  capturedAt      DateTime?         // Photo capture date (not upload date)
  gpsLatitude     Decimal?          @db.Decimal(10, 8)
  gpsLongitude    Decimal?          @db.Decimal(11, 8)
  copyright       String?

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([assigneeId])
  @@index([dueDate])
  @@index([platforms])
  @@map("asset_metadata")
}

// Smart Collections
model Collection {
  id              String            @id @default(cuid())
  projectId       String
  project         MediaProject      @relation(fields: [projectId], references: [id], onDelete: Cascade)

  name            String
  description     String?           @db.Text

  // Collection behavior
  isDynamic       Boolean           @default(true)  // Smart folder vs manual folder

  // Filters for dynamic collections (stored as JSON)
  filters         Json?             // { starRating: [5], status: ["APPROVED"], mediaType: ["IMAGE"] }

  // Grouping and sorting
  groupBy         String?           // "starRating", "status", "uploadedBy", etc.
  sortBy          String            @default("uploadedAt")
  sortOrder       SortOrder         @default(DESC)

  // Sharing
  isShared        Boolean           @default(false)
  shareToken      String?           @unique  // For public/client access
  sharePassword   String?           // Optional password protection

  // Ownership
  createdBy       String
  creator         User              @relation("CollectionCreator", fields: [createdBy], references: [id])

  // Relations
  items           CollectionItem[]  // Manual items (if not dynamic)

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([projectId])
  @@index([isDynamic])
  @@index([shareToken])
  @@map("collections")
}

// Collection items (for manual collections)
model CollectionItem {
  id              String            @id @default(cuid())
  collectionId    String
  collection      Collection        @relation(fields: [collectionId], references: [id], onDelete: Cascade)

  assetId         String
  asset           MediaAsset        @relation(fields: [assetId], references: [id], onDelete: Cascade)

  order           Int               @default(0)  // Manual ordering
  addedAt         DateTime          @default(now())

  @@unique([collectionId, assetId])
  @@index([collectionId, order])
  @@map("collection_items")
}

// Version control for media
model MediaVersion {
  id              String            @id @default(cuid())
  assetId         String
  asset           MediaAsset        @relation(fields: [assetId], references: [id], onDelete: Cascade)

  versionNumber   Int               // 1, 2, 3, etc.

  // File metadata
  filename        String
  url             String
  key             String
  thumbnailUrl    String?

  // Media properties
  size            BigInt
  duration        Decimal?          @db.Decimal(10, 3)  // Video only
  width           Int?
  height          Int?

  // Change notes
  changeNotes     String?           @db.Text

  // Ownership
  uploadedBy      String
  uploader        User              @relation("MediaVersionUploader", fields: [uploadedBy], references: [id])

  uploadedAt      DateTime          @default(now())

  @@unique([assetId, versionNumber])
  @@index([assetId])
  @@map("media_versions")
}

// Frame annotations (video frames OR photo regions)
model MediaFrame {
  id              String            @id @default(cuid())
  assetId         String
  asset           MediaAsset        @relation(fields: [assetId], references: [id], onDelete: Cascade)

  // Frame position (for videos) OR region (for photos)
  timestamp       Decimal?          @db.Decimal(10, 3)  // Seconds from start (video only)
  frameNumber     Int?              // Calculated frame number (video only)

  // Region on photo (for photo annotations)
  x               Decimal?          @db.Decimal(5, 2)   // X position (% of width)
  y               Decimal?          @db.Decimal(5, 2)   // Y position (% of height)

  // Thumbnail
  thumbnailUrl    String?           // Screenshot at this timestamp/region

  // Ownership
  createdBy       String
  creator         User              @relation("MediaFrameCreator", fields: [createdBy], references: [id])

  // Relations
  comments        FrameComment[]
  drawings        FrameDrawing[]

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([assetId, timestamp])
  @@index([assetId, x, y])
  @@index([createdBy])
  @@map("media_frames")
}

// Comments on specific frames
model FrameComment {
  id              String            @id @default(cuid())
  frameId         String
  frame           MediaFrame        @relation(fields: [frameId], references: [id], onDelete: Cascade)

  // Comment content
  text            String            @db.Text

  // Canvas position (optional - for pin-point comments)
  x               Decimal?          @db.Decimal(5, 2)  // X position (% of media width)
  y               Decimal?          @db.Decimal(5, 2)  // Y position (% of media height)

  // Threading
  parentId        String?
  parent          FrameComment?     @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies         FrameComment[]    @relation("CommentReplies")

  // Collaboration
  authorId        String
  author          User              @relation("FrameCommentAuthor", fields: [authorId], references: [id])
  mentions        String[]          // Array of user IDs mentioned

  // Status
  resolved        Boolean           @default(false)
  resolvedBy      String?
  resolver        User?             @relation("FrameCommentResolver", fields: [resolvedBy], references: [id], onDelete: SetNull)
  resolvedAt      DateTime?

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([frameId])
  @@index([parentId])
  @@index([authorId])
  @@index([resolved])
  @@map("frame_comments")
}

// Drawing/markup data on frames
model FrameDrawing {
  id              String            @id @default(cuid())
  frameId         String
  frame           MediaFrame        @relation(fields: [frameId], references: [id], onDelete: Cascade)

  // Drawing type
  type            DrawingType       // ARROW, CIRCLE, RECTANGLE, FREEHAND, TEXT

  // Drawing data (stored as JSON)
  data            Json              // Contains coordinates, colors, stroke width, etc.

  // Creator
  createdBy       String
  creator         User              @relation("FrameDrawingCreator", fields: [createdBy], references: [id])

  createdAt       DateTime          @default(now())

  @@index([frameId])
  @@map("frame_drawings")
}

// Collaborators on media projects (supports both internal users and guest collaborators)
model MediaCollaborator {
  id              String            @id @default(cuid())
  projectId       String
  project         MediaProject      @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // EITHER linked to internal user OR guest email (one must be set, not both)
  userId          String?           // NULL for guests
  user            User?             @relation("MediaCollaboratorUser", fields: [userId], references: [id], onDelete: Cascade)

  guestEmail      String?           // NULL for internal users
  guestName       String?           // Guest's display name

  role            CollaboratorRole  @default(VIEWER)

  // Invited by
  invitedBy       String
  inviter         User              @relation("MediaCollaboratorInviter", fields: [invitedBy], references: [id])

  // Guest-specific fields
  inviteToken     String?   @unique // Secure token for guest access
  status          InviteStatus @default(PENDING)
  lastAccessAt    DateTime?         // Track when guest last accessed
  expiresAt       DateTime?         // Optional expiration (30 days default for guests)

  addedAt         DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@unique([projectId, userId])
  @@unique([projectId, guestEmail])
  @@index([projectId])
  @@index([userId])
  @@index([inviteToken])
  @@index([guestEmail])
  @@index([status])
  @@map("media_collaborators")
}

// ============================================
// MEDIA COLLABORATION ENUMS
// ============================================

enum MediaAssetType {
  VIDEO           // MP4, WebM, MOV, etc.
  IMAGE           // JPEG, PNG, GIF, WebP, etc.
  RAW_IMAGE       // CR2, NEF, ARW, DNG, etc.
}

enum MediaReviewStatus {
  DRAFT           // Not ready for review
  IN_REVIEW       // Actively being reviewed
  NEEDS_CHANGES   // Revisions requested
  APPROVED        // Final approval
  ARCHIVED        // Old/inactive
}

enum CollaboratorRole {
  OWNER           // Full control (delete, manage collaborators)
  EDITOR          // Upload versions, manage comments
  COMMENTER       // Add comments and drawings
  VIEWER          // View only, no interaction
}

enum PublicAccessLevel {
  VIEW_ONLY       // Can only view assets
  DOWNLOAD        // Can view and download
  COMMENT         // Can view and comment (future)
}

enum InviteStatus {
  PENDING         // Invite sent, not accepted yet
  ACCEPTED        // Guest has accessed the project
  EXPIRED         // Invite expired
  REVOKED         // Access revoked by owner
}

enum DrawingType {
  ARROW
  CIRCLE
  RECTANGLE
  FREEHAND
  TEXT
}

enum SortOrder {
  ASC
  DESC
}

// ============================================
// DECK PRESENTATION ENUMS
// ============================================

enum SlideTemplate {
  TITLE           // Large title + subtitle
  TITLE_CONTENT   // Title with content area
  TWO_COLUMN      // Two equal columns
  FULL_MEDIA      // Full-bleed image/video
  MOOD_BOARD      // Grid of images (2x2, 3x3)
  CHARACTER       // Character profile (image + attributes)
  SHOT_LIST       // Tabular shot breakdown
  SCHEDULE        // Timeline/stripboard view
  COMPARISON      // Side-by-side comparison
  BLANK           // Empty canvas
}

enum DeckStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

// ============================================
// DECK PRESENTATION MODELS
// ============================================

// Main deck container
model Deck {
  id              String            @id @default(cuid())
  title           String
  description     String?           @db.Text
  status          DeckStatus        @default(DRAFT)

  // Theme settings (JSON for flexibility)
  theme           Json?             // { primaryColor, fontFamily, logoUrl, etc. }

  // Ownership
  createdById     String
  createdBy       User              @relation("DeckCreator", fields: [createdById], references: [id])

  // Optional business entity links
  clientId        String?
  client          Client?           @relation(fields: [clientId], references: [id], onDelete: SetNull)
  projectId       String?
  project         Project?          @relation(fields: [projectId], references: [id], onDelete: SetNull)
  mediaProjectId  String?
  mediaProject    MediaProject?     @relation(fields: [mediaProjectId], references: [id], onDelete: SetNull)

  // PUBLIC SHARING (follows MediaProject pattern)
  isPublic           Boolean            @default(false)
  publicShareToken   String?            @unique
  publicShareUrl     String?
  publicViewCount    Int                @default(0)
  publicSharedAt     DateTime?
  publicAccessLevel  PublicAccessLevel  @default(VIEW_ONLY)

  // Presentation settings
  slideWidth      Int               @default(1920)  // Default 16:9
  slideHeight     Int               @default(1080)

  // Relations
  slides          DeckSlide[]
  collaborators   DeckCollaborator[]

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([createdById])
  @@index([clientId])
  @@index([projectId])
  @@index([mediaProjectId])
  @@index([publicShareToken])
  @@index([status])
  @@map("decks")
}

// Individual slides
model DeckSlide {
  id              String            @id @default(cuid())
  deckId          String
  deck            Deck              @relation(fields: [deckId], references: [id], onDelete: Cascade)

  // Ordering
  order           Int               @default(0)

  // Template and content
  template        SlideTemplate     @default(BLANK)
  title           String?
  subtitle        String?

  // Flexible content storage (JSON)
  // Structure depends on template, e.g.:
  // MOOD_BOARD: { images: [{ url, caption, order }], columns: 3 }
  // SHOT_LIST: { shots: [{ number, size, angle, description }] }
  // TWO_COLUMN: { left: { type, content }, right: { type, content } }
  content         Json              @default("{}")

  // Background settings
  backgroundColor String?           @default("#FFFFFF")
  backgroundImage String?           // R2 URL
  backgroundImageKey String?        // R2 key for deletion

  // Speaker notes
  notes           String?           @db.Text

  // Transition settings
  transition      String?           @default("fade")  // fade, slide, zoom, none
  transitionDuration Int            @default(500)     // milliseconds

  // Relations
  elements        DeckSlideElement[]
  comments        DeckSlideComment[]

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([deckId])
  @@index([deckId, order])
  @@map("deck_slides")
}

// Flexible elements on slides (text boxes, images, shapes, etc.)
model DeckSlideElement {
  id              String            @id @default(cuid())
  slideId         String
  slide           DeckSlide         @relation(fields: [slideId], references: [id], onDelete: Cascade)

  // Element type
  type            String            // TEXT, IMAGE, VIDEO, SHAPE, ICON

  // Position and size (percentage-based for responsiveness)
  x               Float             @default(0)      // % from left
  y               Float             @default(0)      // % from top
  width           Float             @default(100)    // % of slide width
  height          Float             @default(100)    // % of slide height
  rotation        Float             @default(0)      // degrees
  zIndex          Int               @default(0)

  // Content (type-specific JSON)
  // TEXT: { text, fontSize, fontFamily, fontWeight, color, align }
  // IMAGE: { url, key, alt, objectFit }
  // VIDEO: { url, key, autoplay, loop, muted }
  // SHAPE: { shape, fill, stroke, strokeWidth }
  content         Json              @default("{}")

  // Locking (prevent accidental edits)
  isLocked        Boolean           @default(false)

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([slideId])
  @@index([slideId, zIndex])
  @@map("deck_slide_elements")
}

// Slide-level comments (follows FrameComment pattern)
model DeckSlideComment {
  id              String            @id @default(cuid())
  slideId         String
  slide           DeckSlide         @relation(fields: [slideId], references: [id], onDelete: Cascade)

  // Author (user or guest)
  userId          String?
  user            User?             @relation("DeckSlideCommentAuthor", fields: [userId], references: [id], onDelete: SetNull)
  guestName       String?
  guestEmail      String?

  // Comment content
  content         String            @db.Text

  // Position on slide (optional - for positioned comments)
  positionX       Float?            // % from left
  positionY       Float?            // % from top

  // Threading
  parentId        String?
  parent          DeckSlideComment? @relation("CommentThread", fields: [parentId], references: [id], onDelete: Cascade)
  replies         DeckSlideComment[] @relation("CommentThread")

  // Status
  isResolved      Boolean           @default(false)

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([slideId])
  @@index([parentId])
  @@index([userId])
  @@map("deck_slide_comments")
}

// Deck collaborators (follows MediaCollaborator pattern)
model DeckCollaborator {
  id              String            @id @default(cuid())
  deckId          String
  deck            Deck              @relation(fields: [deckId], references: [id], onDelete: Cascade)

  // Internal user OR guest
  userId          String?
  user            User?             @relation("DeckCollaboratorUser", fields: [userId], references: [id], onDelete: Cascade)
  guestEmail      String?
  guestName       String?

  // Role (reuse CollaboratorRole enum)
  role            CollaboratorRole  @default(VIEWER)

  // Invite tracking
  inviteToken     String?           @unique
  invitedBy       String
  inviter         User              @relation("DeckInviter", fields: [invitedBy], references: [id])
  status          InviteStatus      @default(PENDING)
  expiresAt       DateTime?
  acceptedAt      DateTime?

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@unique([deckId, userId])
  @@unique([deckId, guestEmail])
  @@index([deckId])
  @@index([userId])
  @@index([inviteToken])
  @@index([status])
  @@map("deck_collaborators")
}

// ============================================
// SHOT LIST MODELS
// ============================================

model ShotList {
  id          String   @id @default(cuid())
  name        String
  description String?
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdById String
  createdBy   User     @relation("ShotListCreator", fields: [createdById], references: [id])

  scenes      ShotListScene[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([projectId])
  @@map("shot_lists")
}

model ShotListScene {
  id          String   @id @default(cuid())
  shotListId  String
  shotList    ShotList @relation(fields: [shotListId], references: [id], onDelete: Cascade)
  sceneNumber String
  name        String
  location    String?
  intExt      String?  // INT / EXT
  dayNight    String?  // DAY / NIGHT
  description String?
  order       Int      @default(0)

  shots       Shot[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([shotListId])
  @@map("shot_list_scenes")
}

model Shot {
  id              String         @id @default(cuid())
  sceneId         String
  scene           ShotListScene  @relation(fields: [sceneId], references: [id], onDelete: Cascade)
  shotNumber      String
  order           Int            @default(0)

  // Shot Specs
  shotSize        String?        // EWS, WS, FS, MWS, MS, MCU, CU, ECU
  shotType        String?        // MASTER, SINGLE, TWO_SHOT, OTS, POV, INSERT
  cameraAngle     String?        // EYE_LEVEL, LOW_ANGLE, HIGH_ANGLE, DUTCH, BIRD'S_EYE
  cameraMovement  String?        // STATIC, PAN, TILT, DOLLY, TRACK, CRANE, HANDHELD, STEADICAM
  lens            String?        // 14mm - 200mm
  frameRate       String?        // 24fps, 30fps, 60fps, 120fps
  camera          String?        // A CAM, B CAM, C CAM, DRONE

  // Content
  description     String?
  action          String?
  dialogue        String?
  notes           String?

  // Storyboard
  storyboardUrl   String?
  storyboardKey   String?

  // Production
  setupNumber     Int?           // Camera/lighting setup group
  estimatedTime   Int?           // Seconds
  status          ShotStatus     @default(PLANNED)

  // VFX/SFX
  vfx             String?
  sfx             String?

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([sceneId])
  @@map("shots")
}

enum ShotStatus {
  PLANNED
  IN_PROGRESS
  SHOT
  WRAPPED
  CUT
}

// ============================================
// SHOOTING SCHEDULE MODELS
// ============================================

model ShootingSchedule {
  id          String   @id @default(cuid())
  name        String
  description String?
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  shotListId  String?  // Optional link to shot list
  createdById String
  createdBy   User     @relation("ScheduleCreator", fields: [createdById], references: [id])

  // Settings
  startDate   DateTime?
  pagesPerDay Float    @default(5)  // Estimated pages per day

  shootDays   ShootDay[]
  callSheets  CallSheet[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([projectId])
  @@map("shooting_schedules")
}

model ShootDay {
  id          String           @id @default(cuid())
  scheduleId  String
  schedule    ShootingSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  dayNumber   Int              // Day 1, Day 2, etc.
  shootDate   DateTime?        // Actual date if set
  location    String?          // Main location for the day
  notes       String?
  order       Int              @default(0)

  strips      ScheduleStrip[]
  callSheet   CallSheet?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([scheduleId])
  @@map("shoot_days")
}

model ScheduleStrip {
  id          String    @id @default(cuid())
  shootDayId  String
  shootDay    ShootDay  @relation(fields: [shootDayId], references: [id], onDelete: Cascade)
  order       Int       @default(0)

  // Strip type
  stripType   StripType @default(SCENE)

  // Scene reference (if SCENE type)
  sceneId     String?   // Reference to ShotListScene

  // Scene data (denormalized for display)
  sceneNumber String?
  sceneName   String?
  intExt      String?   // INT / EXT
  dayNight    String?   // DAY / NIGHT
  location    String?
  pageCount   Float?    // 1/8 pages (e.g., 2.5 = 2 4/8)
  estimatedTime Int?    // Minutes

  // Banner data (if BANNER type)
  bannerType  BannerType?
  bannerText  String?
  bannerColor String?   // Hex color

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([shootDayId])
  @@map("schedule_strips")
}

enum StripType {
  SCENE
  BANNER
}

enum BannerType {
  DAY_BREAK
  MEAL_BREAK
  COMPANY_MOVE
  NOTE
}

// ============================================
// CALL SHEET MODELS
// ============================================

model CallSheet {
  id            String           @id @default(cuid())
  scheduleId    String
  schedule      ShootingSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  shootDayId    String           @unique
  shootDay      ShootDay         @relation(fields: [shootDayId], references: [id], onDelete: Cascade)
  createdById   String
  createdBy     User             @relation("CallSheetCreator", fields: [createdById], references: [id])

  // Header Info
  callSheetNumber Int            @default(1)
  productionName  String?
  director        String?
  producer        String?

  // === NEW: Day Context ===
  dayNumber         Int?              // Day 5
  totalDays         Int?              // of 42

  // Date & Time
  shootDate       DateTime
  crewCallTime      String?           // "7:00 AM" - General crew call
  generalCallTime   String?           // Deprecated, use crewCallTime - kept for backward compatibility
  firstShotTime   String?        // e.g., "8:00 AM" / "9:15 AM"
  estimatedWrap   String?        // "6:00 PM" - Expected wrap
  wrapTime        String?        // Deprecated, use estimatedWrap
  lunchTime       String?        // "12:00 PM" - Scheduled lunch

  // Location
  locationName    String?
  locationAddress String?
  parkingNotes    String?
  mapUrl          String?

  // Weather (optional integration)
  weatherHigh     Int?
  weatherLow      Int?
  weatherCondition String?
  sunrise         String?
  sunset          String?

  // Emergency
  nearestHospital String?
  hospitalAddress String?
  hospitalPhone   String?

  // === NEW: Production Details ===
  advanceNotes      String?           // Tomorrow's preview notes
  safetyNotes       String?           // Safety information
  announcements     String?           // Important announcements
  walkieChannels    String?           // "Ch1: Production, Ch2: Camera"

  // Notes
  generalNotes    String?           // Deprecated, kept for backward compatibility
  productionNotes String?

  // Status
  status          CallSheetStatus @default(DRAFT)
  sentAt          DateTime?

  // === Relations: NEW ===
  mealBreaks        CallSheetMeal[]
  companyMoves      CallSheetMove[]
  specialRequirements CallSheetSpecialReq[]
  backgroundCalls   CallSheetBackground[]

  // Relations: Existing
  castCalls         CallSheetCast[]
  crewCalls         CallSheetCrew[]
  scenes            CallSheetScene[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([scheduleId])
  @@map("call_sheets")
}

model CallSheetCast {
  id          String    @id @default(cuid())
  callSheetId String
  callSheet   CallSheet @relation(fields: [callSheetId], references: [id], onDelete: Cascade)
  order       Int       @default(0)

  // Cast info
  castNumber  String?   // #1, #2, etc.
  actorName   String
  character   String?

  // === ENHANCED: Multiple Time Columns ===
  pickupTime  String?   // "6:00 AM" - Transportation pickup
  muCallTime  String?   // "6:30 AM" - Makeup/Hair call (renamed from callTime)
  callTime    String    // e.g., "6:00 AM" - Legacy, kept for compatibility
  onSetTime   String?   // "9:00 AM" - Must be camera-ready
  wrapTime    String?   // "4:00 PM" - Expected wrap for this actor

  // === NEW: Status Code ===
  workStatus  CastWorkStatus @default(W)  // SW, W, WF, SWF, H

  // === NEW: Enhanced Info ===
  transportMode String?       // "Company Car" / "Own Transport" / "Hotel Shuttle"
  muDuration    Int?          // Minutes needed for makeup (e.g., 120 = 2 hours)
  wardrobeNotes String?       // Special wardrobe requirements

  // === NEW: Flags ===
  isMinor       Boolean       @default(false)  // Child actor
  hasStunt      Boolean       @default(false)  // Performing stunts

  // Notes
  notes       String?
  status      CallStatus @default(PENDING)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([callSheetId])
  @@map("call_sheet_cast")
}

model CallSheetCrew {
  id          String    @id @default(cuid())
  callSheetId String
  callSheet   CallSheet @relation(fields: [callSheetId], references: [id], onDelete: Cascade)
  order       Int       @default(0)

  // Crew info
  department  String    // e.g., "Camera", "Grip", "Art"
  position    String    // e.g., "DP", "1st AC", "Gaffer"
  name        String

  // Times
  callTime    String    // e.g., "6:30 AM"

  // === NEW: Staggered Call Time ===
  callTimeOffset  Int?        // Minutes relative to general call (-60 = 1hr early)
  reportLocation  String?     // Where to report (may differ from set)

  // Contact
  phone       String?
  email       String?

  // Notes
  notes       String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([callSheetId])
  @@map("call_sheet_crew")
}

model CallSheetScene {
  id          String    @id @default(cuid())
  callSheetId String
  callSheet   CallSheet @relation(fields: [callSheetId], references: [id], onDelete: Cascade)
  order       Int       @default(0)

  // Scene info (from schedule strip)
  sceneNumber String
  sceneName   String?
  intExt      String?
  dayNight    String?
  location    String?
  pageCount   Float?

  // Cast in scene
  castIds     String?   // Comma-separated cast numbers: "1,2,5"

  // Notes
  description String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([callSheetId])
  @@map("call_sheet_scenes")
}

// === NEW MODEL: Meal Breaks ===
model CallSheetMeal {
  id          String    @id @default(cuid())
  callSheetId String
  callSheet   CallSheet @relation(fields: [callSheetId], references: [id], onDelete: Cascade)

  mealType    MealType  // BREAKFAST, LUNCH, DINNER, CRAFT_SERVICES
  time        String    // "12:00 PM"
  duration    Int       @default(30)  // Minutes
  location    String?   // Where meal is served
  notes       String?
  order       Int       @default(0)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([callSheetId])
  @@map("call_sheet_meals")
}

enum MealType {
  BREAKFAST
  LUNCH
  SECOND_MEAL
  CRAFT_SERVICES
  CATERING
}

// === NEW MODEL: Company Moves ===
model CallSheetMove {
  id          String    @id @default(cuid())
  callSheetId String
  callSheet   CallSheet @relation(fields: [callSheetId], references: [id], onDelete: Cascade)

  departTime  String    // "1:00 PM"
  fromLocation String
  toLocation  String
  travelTime  Int?      // Estimated minutes
  notes       String?
  order       Int       @default(0)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([callSheetId])
  @@map("call_sheet_moves")
}

// === NEW MODEL: Special Requirements ===
model CallSheetSpecialReq {
  id          String    @id @default(cuid())
  callSheetId String
  callSheet   CallSheet @relation(fields: [callSheetId], references: [id], onDelete: Cascade)

  reqType     SpecialReqType
  description String
  contactName String?
  contactPhone String?
  safetyNotes String?
  scenes      String?   // Which scenes this applies to
  order       Int       @default(0)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([callSheetId])
  @@map("call_sheet_special_reqs")
}

enum SpecialReqType {
  STUNTS
  MINORS
  ANIMALS
  VEHICLES
  SFX_PYRO
  WATER_WORK
  AERIAL_DRONE
  WEAPONS
  NUDITY
  OTHER
}

// === NEW MODEL: Background/Extras ===
model CallSheetBackground {
  id          String    @id @default(cuid())
  callSheetId String
  callSheet   CallSheet @relation(fields: [callSheetId], references: [id], onDelete: Cascade)

  description String    // "20 Office Workers", "50 Crowd Extras"
  quantity    Int       @default(1)
  callTime    String
  reportLocation String?
  wardrobeNotes String? // "Business casual provided"
  scenes      String?   // Which scenes
  notes       String?
  order       Int       @default(0)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([callSheetId])
  @@map("call_sheet_background")
}

enum CastWorkStatus {
  SW    // Start Work - First day on set
  W     // Work - Continuing work
  WF    // Work Finish - Final day
  SWF   // Start-Work-Finish - Day player (one day only)
  H     // Hold - On standby, not working today
}

enum CallSheetStatus {
  DRAFT
  READY
  SENT
  UPDATED
}

enum CallStatus {
  PENDING
  CONFIRMED
  ON_SET
  WRAPPED
}
